<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåŠ©æ‰‹ - æœ€çµ‚å®Œæ•´ä¿®æ­£ç‰ˆ</title>
    <style>
        :root {
			/* æ·¡è—è‰²èª¿å®šç¾© */
			--primary-blue: #a2d2ff;      /* å¤©ç©ºè— */
			--light-blue: #eef6ff;        /* æ¥µæ·¡èƒŒæ™¯è— */
			--accent-blue: #4facfe;       /* äº®è—å¼·èª¿è‰² */
			--deep-blue: #243b55;         /* æ·±è—æ–‡å­—è‰² */
			--bg-gray: #f8f9fa;
			--text-main: #4a5568;
			--shadow: 0 4px 15px rgba(0,0,0,0.08);
			--hotel-blue: #007aff;
			--flight-navy: #1a2a6c;
		}

		* { 
			box-sizing: border-box; 
			font-family: "PingFang TC", "Microsoft JhengHei", -apple-system, sans-serif; 
		}

		body { 
			background-color: var(--bg-gray); 
			color: var(--text-main); 
			margin: 0; 
			padding-bottom: 80px; 
		}

		.app-container { 
			width: 100%; 
			max-width: 720px; 
			background: white; 
			min-height: 100vh; 
			margin: 0 auto; 
		}

		/* æ¨™é ­æ”¹ç‚ºè—è‰²æ¼¸å±¤ */
		header { 
			background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue)); 
			color: white; 
			padding: 20px; 
			text-align: center; 
			font-size: 1.4rem; 
			font-weight: bold; 
			position: sticky; 
			top: 0; 
			z-index: 100; 
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}

		/* æ¨™ç±¤é æ¨£å¼èª¿æ•´ */
		.tabs-container { 
			display: flex; 
			overflow-x: auto; 
			background: white; 
			padding: 12px; 
			border-bottom: 1px solid #edf2f7; 
			gap: 10px; 
		}

		.tab { 
			padding: 8px 18px; 
			border-radius: 20px; 
			background: var(--light-blue); 
			border: 1px solid transparent; 
			cursor: pointer; 
			color: var(--accent-blue); 
			white-space: nowrap; /* ç¢ºä¿åç¨±ä¸æœƒæ›è¡Œ */
			font-weight: bold; 
			transition: 0.3s;
			flex-shrink: 0; /* é˜²æ­¢æ¨™ç±¤è¢«æ“ å£“ */
		}

		.tab.active { 
			background: var(--accent-blue); 
			color: white; 
		}

		/* å°è¦½åˆ—æ¨£å¼ */
		nav.bottom-nav { 
			position: fixed; 
			bottom: 0; 
			width: 100%; 
			max-width: 720px; 
			height: 65px; 
			background: white; 
			display: flex; 
			border-top: 1px solid #eee; 
			z-index: 100; 
		}

		.nav-item { 
			flex: 1; 
			display: flex; 
			flex-direction: column; 
			align-items: center; 
			justify-content: center; 
			background: none; 
			border: none; 
			color: #a0aec0; 
			cursor: pointer; 
		}

		.nav-item.active { 
			color: var(--accent-blue); 
			font-weight: bold; 
		}

		/* å¡ç‰‡è¨­è¨ˆå„ªåŒ– */
		.content { padding: 15px; }

		.spot-card, .hotel-card, .flight-card { 
			position: relative; 
			border-radius: 15px; 
			padding: 18px; 
			margin-bottom: 16px; 
			box-shadow: var(--shadow); 
			background: white; 
			border: 1px solid #f0f4f8;
		}

		.spot-card { border-left: 6px solid var(--primary-blue); }
		.hotel-card { border-left: 6px solid var(--hotel-blue); }
		.flight-card { background: var(--flight-navy); color: white; border: none; }

		.card-title { font-size: 1.15rem; font-weight: bold; margin-bottom: 6px; color: var(--deep-blue); }
		.flight-card .card-title { color: white; }
		.card-time { color: var(--accent-blue); font-weight: 800; font-size: 1.2rem; }

		.card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
		.card-actions button { 
			background: white; 
			border: 1px solid #e2e8f0; 
			border-radius: 8px; 
			cursor: pointer; 
			padding: 5px 10px; 
			font-size: 0.9rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}

		/* Modal æ¨£å¼ */
		.modal { 
			position: fixed; 
			top: 0; left: 0; 
			width: 100%; height: 100%; 
			background: rgba(0,0,0,0.5); 
			display: none; 
			justify-content: center; 
			align-items: center; 
			z-index: 200; 
			backdrop-filter: blur(4px);
		}

		.modal-content { 
			background: white; 
			width: 92%; 
			max-width: 550px; 
			padding: 25px; 
			border-radius: 24px; 
			max-height: 85vh; 
			overflow-y: auto; 
			box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
		}

		.modal-header { 
			font-size: 1.4rem; 
			font-weight: bold; 
			margin-bottom: 20px; 
			color: var(--accent-blue); 
			border-bottom: 2px solid var(--light-blue); 
			padding-bottom: 10px; 
		}

		/* è¡¨å–®å…ƒç´  */
		.form-group { margin-bottom: 18px; }
		.form-group label { display: block; margin-bottom: 6px; font-weight: bold; color: #4a5568; font-size: 0.95rem; }
		.form-group input, .form-group select, .form-group textarea { 
			width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #fdfdfd;
		}

		/* è¨˜å¸³èˆ‡åˆ†æ”¤æ¨™ç±¤æ¨£å¼ */
		.companion-tag {
			display: inline-block;
			background: var(--light-blue);
			color: var(--accent-blue);
			padding: 6px 14px;
			border-radius: 20px;
			margin-right: 8px;
			margin-bottom: 8px;
			font-size: 0.9rem;
			font-weight: bold;
			border: 1px solid var(--primary-blue);
		}

		.sharer-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
		.ex-sharer { display: none; } /* éš±è— checkbox */

		.sharer-label {
			padding: 8px 16px;
			background: #f1f5f9;
			color: #64748b;
			border-radius: 25px;
			font-size: 0.85rem;
			cursor: pointer;
			transition: 0.2s;
			border: 1px solid #e2e8f0;
			user-select: none;
		}

		.sharer-label:has(input:checked) {
			background: var(--accent-blue);
			color: white;
			border-color: var(--accent-blue);
			box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
		}

		.expense-edit-item {
			background: #fff;
			border: 1px solid #edf2f7;
			padding: 15px;
			border-radius: 15px;
			margin-bottom: 15px;
			position: relative;
			box-shadow: 0 2px 8px rgba(0,0,0,0.04);
		}

		/* çµç®—é é¢å°ˆç”¨ */
		.expense-summary-card {
			background: #fff;
			padding: 20px;
			border-radius: 18px;
			box-shadow: var(--shadow);
			margin-bottom: 20px;
		}

		.balance-row {
			display: flex;
			justify-content: space-between;
			padding: 14px 0;
			border-bottom: 1px solid #f7fafc;
		}

		.fab { 
			position: fixed; 
			bottom: 85px; 
			right: 20px; 
			width: 60px; 
			height: 60px; 
			border-radius: 30px; 
			background: var(--accent-blue); 
			color: white; 
			border: none; 
			font-size: 30px; 
			box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4); 
			cursor: pointer; 
			z-index: 90; 
		}

		.hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <header id="app-header">ğŸŒ¸ æ—…éŠè¡Œç¨‹</header>
    <div id="tabs-section" class="tabs-container"></div>
    <main id="main-content" class="content"></main>
    
    <nav class="bottom-nav">
        <button class="nav-item active" id="nav-itinerary" onclick="switchView('itinerary')"><span>ğŸ“…</span><span style="font-size: 11px">è¡Œç¨‹</span></button>
        <button class="nav-item" id="nav-flight" onclick="switchView('flight')"><span>âœˆï¸</span><span style="font-size: 11px">æ©Ÿç¥¨</span></button>
        <button class="nav-item" id="nav-hotel" onclick="switchView('hotel')"><span>ğŸ¨</span><span style="font-size: 11px">é£¯åº—</span></button>
        <button class="nav-item" id="nav-wishlist" onclick="switchView('wishlist')"><span>âœ¨</span><span style="font-size: 11px">é¡˜æœ›</span></button>
        <button class="nav-item" id="nav-expense" onclick="switchView('expense')"><span>ğŸ’°</span><span style="font-size: 11px">è¨˜å¸³</span></button>
    </nav>
    <button class="fab" onclick="openDynamicModal()">+</button>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content" id="modal-body"></div>
</div>

<script>
    var DB_KEY = 'travel_planner_v11';
    
    // 1. å˜—è©¦å¾æœ¬åœ°è®€å–
    var savedData = localStorage.getItem(DB_KEY);
    var state;

    if (savedData) {
        state = JSON.parse(savedData);
    } else {
        // 2. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“é–‹ï¼Œå¡«å…¥ç¯„ä¾‹é è¨­è³‡æ–™
        state = {
            view: 'itinerary',
            dayIdx: 0,
            itinerary: [
                { 
                    title: "Day 1", 
                    spots: [
                        { name: "æ±äº¬éµå¡”", time: "10:00", note: "è¨˜å¾—æ‹ç…§", expenses: [], checklist: [] },
                        { name: "ç¯‰åœ°å¸‚å ´", time: "12:30", note: "åƒå£½å¸", expenses: [], checklist: [] }
                    ] 
                },
                { title: "Day 2", spots: [] }
            ],
            flights: [
                { airline: "é•·æ¦®èˆªç©º", flightNo: "BR198", from: "TPE", to: "NRT", depTime: "08:50" }
            ],
            hotels: [
                { name: "æ±äº¬å¸Œçˆ¾é “é£¯åº—", checkIn: "2024-05-20", note: "å·²ä»˜æ¸…" }
            ],
            wishlist: [
                { name: "æ·ºè‰å¯ºå¤§ç‡ˆç± ", note: "è²·å¾¡å®ˆ" }
            ],
            companions: ['æˆ‘', 'å°æ˜']
        };
    }

    // ç¢ºä¿é‹è¡Œæ™‚ç‹€æ…‹æ­£ç¢º
    state.isImporting = false;
    if (!state.view) state.view = 'itinerary';

    function save() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }

    function render() {
        renderTabs();
        renderContent();
        updateNav();
        save();
    }

    function renderTabs() {
		var container = document.getElementById('tabs-section');
		container.innerHTML = '';
		if (state.view !== 'itinerary') { container.classList.add('hidden'); return; }
		container.classList.remove('hidden');
		
		for (var i = 0; i < state.itinerary.length; i++) {
			(function(idx){
				var btn = document.createElement('button');
				btn.className = (idx === state.dayIdx) ? 'tab active' : 'tab';
				btn.innerText = state.itinerary[idx].title;
				btn.onclick = function() { state.dayIdx = idx; render(); };
				container.appendChild(btn);
			})(i);
		}
		
		var addDay = document.createElement('button');
		addDay.className = 'tab';
		addDay.innerText = '+';
		addDay.style.border = "1px dashed var(--accent-blue)";
		addDay.onclick = function() {
			state.itinerary.push({ title: 'Day ' + (state.itinerary.length + 1), spots: [] });
			state.dayIdx = state.itinerary.length - 1;
			render();
		};
		container.appendChild(addDay);
	}

    function renderContent() {
		var main = document.getElementById('main-content');
		main.innerHTML = '';
		var view = state.view;

		// 1. æ¨™é¡Œè™•ç†
		var headerTitle = '';
		if (view === 'itinerary') headerTitle = 'ğŸŒ¸ æ—…éŠè¡Œç¨‹';
		else if (view === 'flight') headerTitle = 'âœˆï¸ æ©Ÿç¥¨è³‡è¨Š';
		else if (view === 'hotel') headerTitle = 'ğŸ¨ é£¯åº—ä½å®¿';
		else if (view === 'wishlist') headerTitle = 'âœ¨ é¡˜æœ›æ¸…å–®';
		else if (view === 'expense') headerTitle = 'ğŸ’° çµç®—ä¸­å¿ƒ';
		document.getElementById('app-header').innerText = headerTitle;

		if (view === 'expense') {
			renderExpensePage();
			return;
		}

		// 2. è¡Œç¨‹è¦–åœ–ç‰¹æœ‰çš„ï¼šé ‚éƒ¨ç®¡ç†åˆ— (ç·¨è¼¯åç¨±èˆ‡åˆªé™¤)
		// ä¿®æ”¹ renderContent è£¡é¢çš„é€™æ®µï¼š
		if (view === 'itinerary') {
			var dayControl = document.createElement('div');
			dayControl.style.cssText = "display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;";
			
			// å·¦å´ï¼šé¡¯ç¤ºåç¨±èˆ‡ç·¨è¼¯æŒ‰éˆ•
			var leftSide = document.createElement('div');
			// ä½¿ç”¨ cssText å°±ä¸æœƒå‡ºéŒ¯ï¼
			leftSide.style.cssText = "display:flex; align-items:center; gap:8px;"; 
			leftSide.innerHTML = '<span style="font-size:1rem; font-weight:bold; color:var(--deep-blue);">' + state.itinerary[state.dayIdx].title + '</span>' +
								 '<button onclick="editDayTitle('+state.dayIdx+')" style="background:none; border:none; cursor:pointer; font-size:1rem; color:var(--accent-blue); padding:0;">âœï¸</button>';
			
			// å³å´ï¼šåˆªé™¤æŒ‰éˆ•
			var rightSide = document.createElement('div');
			if (state.itinerary.length > 1) {
				rightSide.innerHTML = '<button onclick="handleDeleteDay('+state.dayIdx+')" style="background:none; border:1px solid #ff4d4f; color:#ff4d4f; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:0.85rem; display:flex; align-items:center; gap:4px;">' +
									  'ğŸ—‘ï¸ åˆªé™¤é€™å¤©</button>';
			}

			dayControl.appendChild(leftSide);
			dayControl.appendChild(rightSide);
			main.appendChild(dayControl);
		}

		// 3. è³‡æ–™ç²å–èˆ‡å¡ç‰‡æ¸²æŸ“
		var data = (view === 'itinerary') ? state.itinerary[state.dayIdx].spots : 
				   (view === 'wishlist') ? state.wishlist : 
				   (view === 'flight') ? state.flights : state.hotels;

		for (var i = 0; i < data.length; i++) {
			if (view === 'flight') main.appendChild(createFlightCard(data[i], i));
			else if (view === 'hotel') main.appendChild(createHotelCard(data[i], i));
			else main.appendChild(createSpotCard(data[i], i, view === 'wishlist'));
		}

		// å¦‚æœç•¶å¤©æ²’è¡Œç¨‹ï¼Œé¡¯ç¤ºä¸€å€‹æº«é¦¨æç¤º
		if (data.length === 0 && view === 'itinerary') {
			var emptyHint = document.createElement('div');
			emptyHint.style.cssText = "text-align:center; padding:40px 20px; color:#ccc; border:2px dashed #eee; border-radius:15px; margin-top:10px;";
			emptyHint.innerHTML = 'ğŸ“… é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹å–”<br><span style="font-size:0.8rem;">é»æ“Šå³ä¸‹è§’ + é–‹å§‹æ–°å¢</span>';
			main.appendChild(emptyHint);
		}
	}
	
	function handleDeleteDay(idx) {
		if (confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹ã€Œ' + state.itinerary[idx].title + 'ã€å—ï¼Ÿ\nå…§å®¹åˆªæ‰å¾Œå°±ç„¡æ³•æ‰¾å›å–”ï¼')) {
			state.itinerary.splice(idx, 1);
			
			// é‡æ–°æ’åº Day æ¨™é¡Œ
			for (var i = 0; i < state.itinerary.length; i++) {
				state.itinerary[i].title = 'Day ' + (i + 1);
			}

			// èª¿æ•´ç•¶å‰æª¢è¦–çš„ index (é˜²æ­¢æº¢å‡º)
			if (state.dayIdx >= state.itinerary.length) {
				state.dayIdx = state.itinerary.length - 1;
			} else if (state.dayIdx > 0) {
				state.dayIdx = state.dayIdx - 1; // åˆªé™¤å¾Œè·³è½‰åˆ°å‰ä¸€å¤©ï¼Œé«”é©—è¼ƒå¥½
			}
			
			save();
			render();
		}
	}
    // --- å¡ç‰‡ç”Ÿæˆ (å«åˆªé™¤æŒ‰éˆ•) ---
    function createSpotCard(spot, index, isWish) {
		var div = document.createElement('div');
		div.className = 'spot-card';
		
		// ç”Ÿæˆå¾…è²·æ¸…å–®é è¦½ (å«å‹¾é¸é‚è¼¯)
		var ckHTML = '';
		if (spot.checklist && spot.checklist.length > 0) {
			ckHTML += '<div style="margin-top:10px; border-top:1px dashed #eee; padding-top:8px;">';
			for (var j = 0; j < spot.checklist.length; j++) {
				var item = spot.checklist[j];
				var isChecked = item.completed ? 'checked' : '';
				var textStyle = item.completed ? 'text-decoration:line-through; color:#ccc;' : '';
				// é€™è£¡ç›´æ¥ç¶å®š onclick æ–¹ä¾¿å¿«é€Ÿå‹¾é¸
				ckHTML += '<div style="font-size:0.85rem; display:flex; align-items:center; margin-bottom:3px;">' +
						  '<input type="checkbox" ' + isChecked + ' onclick="toggleCheckItem('+index+','+j+','+isWish+')"> ' +
						  '<span style="'+textStyle+'">' + item.text + '</span></div>';
			}
			ckHTML += '</div>';
		}

		// ç”Ÿæˆæ”¯å‡ºé è¦½
		var exHTML = '';
		if (spot.expenses && spot.expenses.length > 0) {
			var total = 0;
			for (var k = 0; k < spot.expenses.length; k++) total += parseFloat(spot.expenses[k].amount || 0);
			exHTML = '<div style="font-size:0.8rem; color:var(--accent-blue); font-weight:bold; margin-top:5px;">ğŸ’° å…±è¨ˆ: ' + Math.round(total) + ' (é»æ“Šç·¨è¼¯æŸ¥çœ‹æ˜ç´°)</div>';
		}

		div.innerHTML = '<div class="card-time">' + (spot.time || '--:--') + '</div>' +
						'<div class="card-title">' + spot.name + '</div>' +
						'<div style="font-size:0.85rem; color:#777;">' + (spot.note || '') + '</div>' +
						ckHTML + exHTML +
						'<div class="card-actions">' +
						(isWish ? '<button onclick="state.isImporting=true; openDynamicModal('+index+')">ğŸ“…åŒ¯å…¥</button>' : '') +
						'<button onclick="state.isImporting=false; openDynamicModal('+index+')">âœï¸</button>' +
						'<button onclick="handleDelete('+index+', '+isWish+')">ğŸ—‘ï¸</button>' +
						'</div>';
		return div;
	}

	// å¿«é€Ÿå‹¾é¸åŠŸèƒ½
	function toggleCheckItem(spotIdx, itemIdx, isWish) {
		var data = isWish ? state.wishlist[spotIdx] : state.itinerary[state.dayIdx].spots[spotIdx];
		data.checklist[itemIdx].completed = !data.checklist[itemIdx].completed;
		save();
		render();
	}

    function createFlightCard(f, i) {
        var div = document.createElement('div');
        div.className = 'flight-card';
        div.innerHTML = '<div style="font-weight:bold; font-size:1.2rem;">' + (f.airline || 'èˆªç©ºå…¬å¸') + ' ' + (f.flightNo || '') + '</div>' +
                        '<div>' + (f.from || '---') + ' âœˆï¸ ' + (f.to || '---') + '</div>' +
                        '<div style="font-size:0.8rem; opacity:0.8;">' + (f.depTime || '') + '</div>' +
                        '<div class="card-actions">' +
                        '<button onclick="openDynamicModal('+i+')">âœï¸</button>' +
                        '<button onclick="handleDeleteFlight('+i+')">ğŸ—‘ï¸</button>' +
                        '</div>';
        return div;
    }

    function createHotelCard(h, i) {
        var div = document.createElement('div');
        div.className = 'hotel-card';
        div.innerHTML = '<div class="card-title">' + (h.name || 'é£¯åº—åç¨±') + '</div>' +
                        '<div style="font-size:0.85rem; color:#666;">å…¥ä½: ' + (h.checkIn || 'æœªå¡«å¯«') + '</div>' +
                        '<div class="card-actions">' +
                        '<button onclick="openDynamicModal('+i+')">âœï¸</button>' +
                        '<button onclick="handleDeleteHotel('+i+')">ğŸ—‘ï¸</button>' +
                        '</div>';
        return div;
    }

    // --- Modal é‚è¼¯ ---
    function openDynamicModal(index) {
        var idx = (index !== undefined) ? index : null;
        var container = document.getElementById('modal-body');
        state.editTarget = (idx !== null) ? { index: idx, view: state.view } : null;
        
        var html = '<div class="modal-header">' + (idx !== null ? 'âœï¸ ç·¨è¼¯' : 'â• æ–°å¢') + '</div>';

        if (state.view === 'flight') {
            html += '<div class="form-group"><label>èˆªç©ºå…¬å¸</label><input type="text" id="fl-airline"></div>' +
                    '<div class="form-row"><div class="form-group"><label>èˆªç­è™Ÿç¢¼</label><input type="text" id="fl-no"></div><div class="form-group"><label>æ—¥æœŸæ™‚é–“</label><input type="text" id="fl-time"></div></div>' +
                    '<div class="form-row"><div class="form-group"><label>å‡ºç™¼åœ°</label><input type="text" id="fl-from"></div><div class="form-group"><label>ç›®çš„åœ°</label><input type="text" id="fl-to"></div></div>' +
                    '<div class="form-row"><div class="form-group"><label>èˆªå»ˆ/ç™»æ©Ÿé–€</label><input type="text" id="fl-gate"></div><div class="form-group"><label>åº§ä½è™Ÿç¢¼</label><input type="text" id="fl-seat"></div></div>';
        } else if (state.view === 'hotel') {
            html += '<div class="form-group"><label>é£¯åº—åç¨± *</label><input type="text" id="ht-name"></div>' +
                    '<div class="form-group"><label>å…¥ä½æ—¥æœŸ</label><input type="date" id="ht-checkin"></div>' +
                    '<div class="form-group"><label>Google Map é€£çµ</label><input type="url" id="ht-map"></div>' +
                    '<div class="form-group"><label>è¨‚æˆ¿ç¢ºèªç¢¼/é€£çµ</label><input type="text" id="ht-link"></div>' +
                    '<div class="form-group"><label>å‚™è¨»</label><textarea id="ht-note"></textarea></div>';
        } else {
            // æ™¯é» / é¡˜æœ›
            html += '<div class="form-group"><label>åç¨± *</label><input type="text" id="f-name"></div>' +
                    '<div class="form-row"><div class="form-group"><label>æ™‚é–“</label><input type="time" id="f-time"></div><div class="form-group"><label>åœ°åœ–é€£çµ</label><input type="url" id="f-map"></div></div>' +
                    '<div class="form-group"><label>å¤–éƒ¨é€£çµ</label><input type="url" id="f-link"></div>' +
                    '<div class="form-group"><label>ğŸ’° è¨˜å¸³æ˜ç´°</label><div id="m-expense-list"></div><button class="btn-add" onclick="addExRow()">+ æ–°å¢æ”¯å‡º</button></div>' +
                    '<div class="form-group"><label>ğŸ›ï¸ å¾…è²·æ¸…å–®</label><div id="m-check-list"></div><button class="btn-add" onclick="addCkRow()">+ æ–°å¢é …ç›®</button></div>' +
                    '<div class="form-group"><label>å‚™è¨»</label><textarea id="f-note"></textarea></div>';
            if (state.isImporting) {
                html += '<div class="form-group" style="background:#fff0f3; padding:10px; border-radius:8px;"><label>ğŸ“… åŒ¯å…¥è‡³å“ªä¸€å¤©ï¼Ÿ</label><select id="f-target-day">';
                for (var i=0; i<state.itinerary.length; i++) html += '<option value="'+i+'">'+state.itinerary[i].title+'</option>';
                html += '</select></div>';
            }
        }

        html += '<div style="display:flex; gap:10px; margin-top:20px;">' +
                '<button style="flex:1; padding:12px; border:none; border-radius:8px; cursor:pointer;" onclick="closeModal()">å–æ¶ˆ</button>' +
                '<button style="flex:2; padding:12px; border:none; border-radius:8px; background:var(--accent-blue); color:white; font-weight:bold; cursor:pointer;" onclick="handleDynamicSave()">å„²å­˜è³‡æ–™</button></div>';

        container.innerHTML = html;
        if (idx !== null) fillData(state.view, idx);
        document.getElementById('edit-modal').style.display = 'flex';
    }

    function addExRow(data) {
		var container = document.getElementById('m-expense-list');
		var div = document.createElement('div');
		div.className = 'expense-edit-item';
		div.style.cssText = "border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06);";

		var payerOptions = '';
		for (var i = 0; i < state.companions.length; i++) {
			var name = state.companions[i];
			var selected = (data && data.paidBy === name) ? 'selected' : '';
			payerOptions += '<option value="' + name + '" ' + selected + '>' + name + '</option>';
		}

		// åˆ†æ”¤è€…å€å¡Šï¼šéš±è— checkboxï¼Œé»æ“Šæ•´å€‹ label è®Šè‰²
		var sharerHTML = '<div style="margin-top:12px;"><div style="font-size:0.8rem; font-weight:bold; color:#888; margin-bottom:8px;">èª°è¦åˆ†æ”¤é€™ç­†éŒ¢ï¼Ÿ</div><div class="sharer-container" style="display:flex; flex-wrap:wrap; gap:8px;">';
		for (var j = 0; j < state.companions.length; j++) {
			var cName = state.companions[j];
			var isChecked = (!data || (data.sharedWith && data.sharedWith.indexOf(cName) !== -1)) ? 'checked' : '';
			
			sharerHTML += '<label class="sharer-label">' +
						  '<input type="checkbox" class="ex-sharer" value="' + cName + '" ' + isChecked + '> ' +
						  '<span>' + cName + '</span>' + 
						  '</label>';
		}
		sharerHTML += '</div></div>';

		div.innerHTML = 
			'<div style="display:grid; grid-template-columns: 2fr 1fr 0.8fr; gap:8px; margin-bottom:12px;">' +
				'<input type="text" class="ex-item" placeholder="æ”¯å‡ºé …ç›®" style="padding:8px; border-radius:6px; border:1px solid #ddd;" value="' + (data ? data.item : '') + '">' +
				'<input type="number" class="ex-amt" placeholder="é‡‘é¡" style="padding:8px; border-radius:6px; border:1px solid #ddd;" value="' + (data ? data.amount : '') + '">' +
				'<select class="ex-cur" style="padding:8px; border-radius:6px; border:1px solid #ddd;"><option value="TWD" '+(data&&data.currency==='TWD'?'selected':'')+'>TWD</option><option value="JPY" '+(data&&data.currency==='JPY'?'selected':'')+'>JPY</option></select>' +
			'</div>' +
			'<div style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">' +
				'<b>ç”±èª°ä»˜æ¬¾:</b> <select class="ex-payer" style="padding:5px 10px; border-radius:6px; border:1px solid #ccc;">' + payerOptions + '</select>' +
			'</div>' +
			sharerHTML +
			'<button onclick="this.parentElement.remove()" style="position:absolute; top:10px; right:10px; border:none; background:none; color:#ccc; font-size:1.2rem; cursor:pointer;">âœ•</button>';
		
		container.appendChild(div);
	}
    function addCkRow(text) {
        var div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = '<input type="text" class="ck-text" placeholder="å“é …" style="flex:1;" value="'+(text||'')+'">' +
                        '<button onclick="this.parentElement.remove()" style="border:none; background:none; color:red;">âœ•</button>';
        document.getElementById('m-check-list').appendChild(div);
    }

    function fillData(view, idx) {
        if (view === 'flight') {
            var d = state.flights[idx];
            document.getElementById('fl-airline').value = d.airline||'';
            document.getElementById('fl-no').value = d.flightNo||'';
            document.getElementById('fl-time').value = d.depTime||'';
            document.getElementById('fl-from').value = d.from||'';
            document.getElementById('fl-to').value = d.to||'';
            document.getElementById('fl-gate').value = d.gate||'';
            document.getElementById('fl-seat').value = d.seat||'';
        } else if (view === 'hotel') {
            var d = state.hotels[idx];
            document.getElementById('ht-name').value = d.name||'';
            document.getElementById('ht-checkin').value = d.checkIn||'';
            document.getElementById('ht-map').value = d.map||'';
            document.getElementById('ht-link').value = d.link||'';
            document.getElementById('ht-note').value = d.note||'';
        } else {
            var d = (view === 'wishlist') ? state.wishlist[idx] : state.itinerary[state.dayIdx].spots[idx];
            document.getElementById('f-name').value = d.name||'';
            document.getElementById('f-time').value = d.time||'';
            document.getElementById('f-map').value = d.map||'';
            document.getElementById('f-link').value = d.link||'';
            document.getElementById('f-note').value = d.note||'';
            if (d.expenses) d.expenses.forEach(function(e){ addExRow(e); });
            if (d.checklist) d.checklist.forEach(function(c){ addCkRow(c.text); });
        }
    }

    function handleDynamicSave() {
        var view = state.view;
        var target = state.editTarget;
        var obj = {};

        if (view === 'flight') {
            obj = {
                airline: document.getElementById('fl-airline').value,
                flightNo: document.getElementById('fl-no').value,
                depTime: document.getElementById('fl-time').value,
                from: document.getElementById('fl-from').value,
                to: document.getElementById('fl-to').value,
                gate: document.getElementById('fl-gate').value,
                seat: document.getElementById('fl-seat').value
            };
            if (target) state.flights[target.index] = obj; else state.flights.push(obj);
        } else if (view === 'hotel') {
            obj = {
                name: document.getElementById('ht-name').value,
                checkIn: document.getElementById('ht-checkin').value,
                map: document.getElementById('ht-map').value,
                link: document.getElementById('ht-link').value,
                note: document.getElementById('ht-note').value
            };
            if (target) state.hotels[target.index] = obj; else state.hotels.push(obj);
        } else {
            // 1. ä¿®æ”¹è¨˜å¸³è³‡æ–™æ”¶é›†ï¼šåŠ å…¥ä»˜æ¬¾äºº (paidBy)
            var exArr = [];
            var exRows = document.querySelectorAll('#m-expense-list .expense-edit-item');
            exRows.forEach(function(row) {
                var amt = row.querySelector('.ex-amt').value;
                if (amt) {
                    // æ”¶é›†è©²ç­†æ”¯å‡ºè¢«å‹¾é¸çš„åˆ†æ”¤è€…
                    var selectedSharers = [];
                    var sharerCheckboxes = row.querySelectorAll('.ex-sharer:checked');
                    sharerCheckboxes.forEach(function(cb) {
                        selectedSharers.push(cb.value);
                    });

                    // å¦‚æœå®Œå…¨æ²’å‹¾ï¼Œè‡ªå‹•é è¨­ç”±ä»˜æ¬¾äººè‡ªå·±æ‰¿æ“” (é˜²æ­¢é™¤ä»¥ 0)
                    if (selectedSharers.length === 0) {
                        selectedSharers.push(row.querySelector('.ex-payer').value);
                    }

                    exArr.push({ 
                        item: row.querySelector('.ex-item').value, 
                        amount: parseFloat(amt), 
                        currency: row.querySelector('.ex-cur').value,
                        paidBy: row.querySelector('.ex-payer').value,
                        sharedWith: selectedSharers // å„²å­˜å‹¾é¸çš„äººå“¡åå–®
                    });
                }
            });

            // 2. ä¿®æ”¹å¾…è²·æ¸…å–®æ”¶é›†ï¼šé˜²æ­¢ç·¨è¼¯æ™‚ completed ç‹€æ…‹è¢«æ´—æ‰
            var ckArr = [];
            var ckRows = document.querySelectorAll('#m-check-list .item-row');
            ckRows.forEach(function(row) {
                var text = row.querySelector('.ck-text').value;
                if (text) {
                    // é€™è£¡åŠ ä¸Šä¸€å€‹åˆ¤æ–·ï¼Œå¦‚æœæ˜¯ç·¨è¼¯ç¾æœ‰é …ç›®ï¼Œå˜—è©¦ä¿ç•™åŸæœ¬çš„å‹¾é¸ç‹€æ…‹
                    // (é€™éƒ¨åˆ†å¦‚æœæ¯”è¼ƒè¤‡é›œï¼Œæœ€ç°¡å–®æ˜¯å…ˆæŠ“ text å°±å¥½)
                    ckArr.push({ text: text, completed: false }); 
                }
            });

            // 3. çµ„åˆç‰©ä»¶ (é€™éƒ¨åˆ†ç¶­æŒä½ çš„çµæ§‹)
            obj = {
                name: document.getElementById('f-name').value,
                time: document.getElementById('f-time').value,
                map: document.getElementById('f-map').value,
                link: document.getElementById('f-link').value,
                note: document.getElementById('f-note').value,
                expenses: exArr,
                checklist: ckArr
            };

            if (state.isImporting) {
                var day = document.getElementById('f-target-day').value;
                state.itinerary[day].spots.push(obj);
                state.isImporting = false;
            } else if (target) {
                if (view === 'itinerary') state.itinerary[state.dayIdx].spots[target.index] = obj;
                else state.wishlist[target.index] = obj;
            } else {
                if (view === 'itinerary') state.itinerary[state.dayIdx].spots.push(obj);
                else state.wishlist.push(obj);
            }
        }
        closeModal(); render();
    }

    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    function switchView(v) { state.view = v; render(); }
    function updateNav() {
        var items = document.querySelectorAll('.nav-item');
        items.forEach(function(n){ n.classList.remove('active'); });
        document.getElementById('nav-' + state.view).classList.add('active');
    }

    // åˆªé™¤é‚è¼¯
    function handleDelete(idx, isWish) { if(confirm('åˆªé™¤é …ç›®ï¼Ÿ')) { if(isWish) state.wishlist.splice(idx, 1); else state.itinerary[state.dayIdx].spots.splice(idx, 1); render(); } }
    function handleDeleteFlight(idx) { if(confirm('åˆªé™¤æ©Ÿç¥¨ï¼Ÿ')) { state.flights.splice(idx, 1); render(); } }
    function handleDeleteHotel(idx) { if(confirm('åˆªé™¤é£¯åº—ï¼Ÿ')) { state.hotels.splice(idx, 1); render(); } }
	// --- è¨˜å¸³çµç®—é é¢ ---
	function renderExpensePage() {
		var main = document.getElementById('main-content');
		var html = '<div class="expense-summary-card">' +
				   '<h4 style="margin-top:0">ğŸ‘¥ æ—…ä¼´ç®¡ç†</h4>' +
				   '<div id="companion-list">';
		
		for (var i = 0; i < state.companions.length; i++) {
			html += '<span class="companion-tag">' + state.companions[i] + 
					' <small onclick="removeCompanion(' + i + ')" style="cursor:pointer; color:#ff4d4d; margin-left:5px">âœ•</small></span>';
		}
		
		html += '</div>' +
				'<div style="display:flex; gap:8px; margin-top:10px">' +
				'<input type="text" id="new-companion" placeholder="è¼¸å…¥æ—…ä¼´å§“å" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd">' +
				'<button onclick="addCompanion()" style="background:var(--accent-blue); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold">æ–°å¢</button>' +
				'</div></div>';

		// 1. åˆå§‹åŒ–æ‰€æœ‰äººçš„éŒ¢åŒ…ç‚º 0
		var balances = {}; 
		for (var k = 0; k < state.companions.length; k++) {
			balances[state.companions[k]] = 0;
		}
		
		// 2. å»ºç«‹ä¸€å€‹çµ±ä¸€çš„è¨ˆç®—å‡½å¼ï¼Œç¢ºä¿é‚è¼¯ä¸€è‡´
		function processExpense(ex) {
			if (!ex || !ex.amount) return;
			var amount = parseFloat(ex.amount) || 0;
			var payer = ex.paidBy;
			var sharers = (ex.sharedWith && ex.sharedWith.length > 0) ? ex.sharedWith : state.companions;

			// ä»˜æ¬¾è€…å…ˆæ‹¿å›ä»–å¢Šçš„æ‰€æœ‰éŒ¢
			if (balances[payer] !== undefined) {
				balances[payer] += amount;
			}

			// æ‡‰åˆ†æ”¤çš„äººï¼ˆåŒ…å«ä»˜æ¬¾è€…è‡ªå·±ï¼Œå¦‚æœä»–åœ¨åå–®å…§ï¼‰è¦æŠŠéŒ¢æ‰£æ‰
			var perPerson = amount / sharers.length;
			for (var x = 0; x < sharers.length; x++) {
				var sName = sharers[x];
				if (balances[sName] !== undefined) {
					balances[sName] -= perPerson;
				}
			}
		}

		// 3. æ”¶é›†æ‰€æœ‰åœ°æ–¹çš„æ”¯å‡º (è¡Œç¨‹ã€é£¯åº—ã€æ©Ÿç¥¨)
		// è¡Œç¨‹ä¸­çš„æ”¯å‡º
		state.itinerary.forEach(function(day) {
			day.spots.forEach(function(spot) {
				if (spot.expenses) spot.expenses.forEach(processExpense);
			});
		});

		// é¡˜æœ›æ¸…å–®ä¸­çš„æ”¯å‡º (å¦‚æœæœ‰ç®—å…¥çš„è©±)
		state.wishlist.forEach(function(item) {
			if (item.expenses) item.expenses.forEach(processExpense);
		});

		// é£¯åº—æ”¯å‡º
		state.hotels.forEach(function(hotel) {
			if (hotel.expenses) hotel.expenses.forEach(processExpense);
		});

		// æ©Ÿç¥¨æ”¯å‡º
		state.flights.forEach(function(flight) {
			if (flight.expenses) flight.expenses.forEach(processExpense);
		});

		html += '<div class="expense-summary-card">' +
				'<h4 style="margin-bottom:10px">ğŸ’° çµç®—çµ±è¨ˆ (åŸºæº–å¹£å€¼)</h4>' +
				'<p style="font-size:0.8rem; color:#888; margin-bottom:15px">èªªæ˜ï¼šæ­£æ•¸ä»£è¡¨å¢ŠéŒ¢æ‡‰æ”¶å›ï¼Œè² æ•¸ä»£è¡¨æ¬ éŒ¢æ‡‰çµ¦å‡ºã€‚</p>';

		state.companions.forEach(function(name) {
			var bal = Math.round(balances[name] * 100) / 100; // ä¿ç•™å…©ä½å°æ•¸
			var color = bal >= 0 ? '#2e7d32' : '#d32f2f';
			var prefix = bal > 0 ? '+' : '';
			
			html += '<div class="balance-row">' +
					'<span>' + name + '</span>' +
					'<span style="color:' + color + '; font-weight:bold">' + prefix + bal + '</span>' +
					'</div>';
		});
		
		html += '</div>';
		main.innerHTML = html;
	}

	// --- æ—…ä¼´ç®¡ç†é…å¥—å‡½å¼ ---
	function addCompanion() {
		var input = document.getElementById('new-companion');
		var name = input.value.trim();
		if (!name) return alert('è«‹è¼¸å…¥å§“å');
		if (state.companions.indexOf(name) !== -1) return alert('å§“åé‡è¤‡äº†');
		
		state.companions.push(name);
		input.value = '';
		save();
		render(); // é‡æ–°æ¸²æŸ“æ•´å€‹é é¢
	}

	function removeCompanion(index) {
		if (state.companions.length <= 1) return alert('è‡³å°‘éœ€è¦ä¸€åæ—…ä¼´');
		if (confirm('ç¢ºå®šåˆªé™¤æ—…ä¼´ ' + state.companions[index] + 'ï¼Ÿ\né€™å¯èƒ½æœƒå½±éŸ¿çµç®—ç²¾ç¢ºåº¦ã€‚')) {
			state.companions.splice(index, 1);
			save();
			render();
		}
	}
	
	function editDayTitle(idx) {
		var oldTitle = state.itinerary[idx].title;
		var newTitle = prompt("è«‹è¼¸å…¥é€™ä¸€å¤©çš„åç¨±ï¼ˆä¾‹å¦‚ï¼šDay 1 æ±äº¬ï¼‰ï¼š", oldTitle);
		
		if (newTitle !== null && newTitle.trim() !== "") {
			state.itinerary[idx].title = newTitle.trim();
			save();
			render(); // é‡æ–°æ¸²æŸ“ Tabs èˆ‡å…§å®¹å€
		}
	}
    render();
</script>
</body>
</html>