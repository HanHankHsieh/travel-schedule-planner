<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåŠ©æ‰‹ - æœ€çµ‚å®Œæ•´ä¿®æ­£ç‰ˆ</title>
    <style>
        :root {
			/* æ·¡è—è‰²èª¿å®šç¾© */
			--primary-blue: #a2d2ff;      /* å¤©ç©ºè— */
			--light-blue: #eef6ff;        /* æ¥µæ·¡èƒŒæ™¯è— */
			--accent-blue: #4facfe;       /* äº®è—å¼·èª¿è‰² */
			--deep-blue: #243b55;         /* æ·±è—æ–‡å­—è‰² */
			--bg-gray: #f8f9fa;
			--text-main: #4a5568;
			--shadow: 0 4px 15px rgba(0,0,0,0.08);
			--hotel-blue: #007aff;
			--flight-navy: #1a2a6c;
		}

		* { 
			box-sizing: border-box; 
			font-family: "PingFang TC", "Microsoft JhengHei", -apple-system, sans-serif; 
		}

		body { 
			background-color: var(--bg-gray); 
			color: var(--text-main); 
			margin: 0; 
			padding-bottom: 80px; 
		}

		.app-container { 
			width: 100%; 
			max-width: 720px; 
			background: white; 
			min-height: 100vh; 
			margin: 0 auto; 
		}

		/* æ¨™é ­è—è‰²æ¼¸å±¤ */
		header { 
			background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue)); 
			color: white; 
			padding: 20px; 
			text-align: center; 
			font-size: 1.4rem; 
			font-weight: bold; 
			position: sticky; 
			top: 0; 
			z-index: 100; 
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}

		/* æ¨™ç±¤é æ¨£å¼ */
		.tabs-container { 
			display: flex; 
			overflow-x: auto; 
			background: white; 
			padding: 15px 12px 10px 12px; 
			border-bottom: 1px solid #edf2f7; 
			gap: 12px; 
			align-items: center;
		}

		.tab { 
			padding: 8px 18px; 
			border-radius: 20px; 
			background: var(--light-blue); 
			border: 1px solid transparent; 
			cursor: pointer; 
			color: var(--accent-blue); 
			white-space: nowrap; 
			font-weight: bold; 
			transition: 0.3s;
			flex-shrink: 0; 
		}

		.tab.active { 
			background: var(--accent-blue); 
			color: white; 
		}

		/* å°è¦½åˆ—æ¨£å¼ */
		nav.bottom-nav { 
			position: fixed; 
			bottom: 0; 
			width: 100%; 
			max-width: 720px; 
			height: 65px; 
			background: white; 
			display: flex; 
			border-top: 1px solid #eee; 
			z-index: 100; 
		}

		.nav-item { 
			flex: 1; 
			display: flex; 
			flex-direction: column; 
			align-items: center; 
			justify-content: center; 
			background: none; 
			border: none; 
			color: #a0aec0; 
			cursor: pointer; 
		}

		.nav-item.active { 
			color: var(--accent-blue); 
			font-weight: bold; 
		}

		/* å¡ç‰‡è¨­è¨ˆèˆ‡é€£çµæ¨£å¼ */
		.content { padding: 15px; }

		.spot-card, .hotel-card { 
			position: relative; 
			border-radius: 15px; 
			padding: 18px; 
			margin-bottom: 16px; 
			box-shadow: var(--shadow); 
			background: white; 
			border: 1px solid #f0f4f8;
		}

		.spot-card { border-left: 6px solid var(--primary-blue); }
		.hotel-card { border-left: 6px solid var(--hotel-blue); }

		/* æ©Ÿç¥¨å¡ç‰‡ - ç™»æ©Ÿè­‰é¢¨æ¨£å¼ */
		.flight-card { 
			background: linear-gradient(135deg, var(--flight-navy), var(--deep-blue)); 
			color: white; 
			border-radius: 18px; 
			padding: 20px; 
			margin-bottom: 16px; 
			box-shadow: 0 6px 15px rgba(26, 42, 108, 0.2);
			position: relative;
			border: none;
		}

		.card-title { font-size: 1.15rem; font-weight: bold; margin-bottom: 6px; color: var(--deep-blue); }
		.flight-card .card-title { color: white; }
		.card-time { color: var(--accent-blue); font-weight: 800; font-size: 1.2rem; }

		/* é€£çµæŒ‰éˆ•æ¨£å¼ */
		.card-link {
			text-decoration: none;
			font-size: 0.85rem;
			color: var(--accent-blue);
			background: var(--light-blue);
			padding: 4px 10px;
			border-radius: 6px;
			font-weight: bold;
			display: inline-flex;
			align-items: center;
			gap: 4px;
			transition: 0.2s;
		}

		.card-link:hover {
			background: var(--primary-blue);
			color: white;
		}

		.card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
		.card-actions button { 
			background: white; 
			border: 1px solid #e2e8f0; 
			border-radius: 8px; 
			cursor: pointer; 
			padding: 5px 10px; 
			font-size: 0.9rem;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
		}

		/* Modal æ¨£å¼ */
		.modal { 
			position: fixed; 
			top: 0; left: 0; 
			width: 100%; height: 100%; 
			background: rgba(0,0,0,0.5); 
			display: none; 
			justify-content: center; 
			align-items: center; 
			z-index: 200; 
			backdrop-filter: blur(4px);
		}

		.modal-content { 
			background: white; 
			width: 92%; 
			max-width: 550px; 
			padding: 25px; 
			border-radius: 24px; 
			max-height: 85vh; 
			overflow-y: auto; 
		}

		/* è¨˜å¸³é¸å–å€å¡Š (é»äº®é‚è¼¯) */
		.sharer-label {
			padding: 8px 16px;
			background: #f1f5f9;
			color: #64748b;
			border-radius: 25px;
			font-size: 0.85rem;
			cursor: pointer;
			transition: 0.2s;
			border: 1px solid #e2e8f0;
			user-select: none;
			display: inline-block;
		}

		.sharer-label:has(input:checked) {
			background: var(--accent-blue);
			color: white;
			border-color: var(--accent-blue);
			box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);
		}

		.ex-sharer { display: none; }

		.fab { 
			position: fixed; 
			bottom: 85px; 
			right: 20px; 
			width: 60px; 
			height: 60px; 
			border-radius: 30px; 
			background: var(--accent-blue); 
			color: white; 
			border: none; 
			font-size: 30px; 
			box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4); 
			cursor: pointer; 
			z-index: 90; 
		}

		.hidden { 
			display: none !important; 
		}

		/* è®“è¡¨å–®å…§çš„æ¬„ä½å¯ä»¥ä¸¦æ’ */
			.form-row {
				display: flex;
				gap: 12px; /* æ¬„ä½ä¹‹é–“çš„é–“è· */
				margin-bottom: 0;
			}

			.form-row .form-group {
				flex: 1; /* è®“ä¸¦æ’çš„æ¬„ä½ç­‰å¯¬ */
			}

			/* é‡å°æ–°å¢æ”¯å‡º/é …ç›®çš„æŒ‰éˆ•ç¾åŒ– */
			.btn-add {
				background: var(--light-blue);
				color: var(--accent-blue);
				border: 1px dashed var(--accent-blue);
				width: 100%;
				padding: 10px;
				border-radius: 10px;
				cursor: pointer;
				font-weight: bold;
				margin-top: 5px;
				transition: 0.3s;
			}

			.btn-add:hover {
				background: var(--accent-blue);
				color: white;
			}
			/* è¡¨å–®çµ„é–“è·èˆ‡æ¨™ç±¤æ¨£å¼ */
			.form-group { 
				margin-bottom: 22px; /* å¢åŠ æ¯å€‹é …ç›®çš„ä¸Šä¸‹å‘¼å¸æ„Ÿ */
			}

			.form-group label { 
				display: block; 
				margin-bottom: 8px; 
				font-weight: 600; 
				color: var(--deep-blue); 
				font-size: 0.9rem;
				letter-spacing: 0.5px;
			}

			/* è¼¸å…¥æ¡†ç¾åŒ–ï¼šå»æ‰ç”Ÿç¡¬é‚Šæ¡†ï¼Œå¢åŠ é™°å½±èˆ‡åœ“è§’ */
			.form-group input, 
			.form-group select, 
			.form-group textarea { 
				width: 100%; 
				padding: 12px 16px; 
				border: 1.5px solid #eef2f7; 
				border-radius: 14px; 
				font-size: 1rem; 
				background: #fdfdfd;
				color: var(--text-main);
				transition: all 0.3s ease;
				outline: none;
				box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
			}

			/* ç•¶é»æ“Šè¼¸å…¥æ¡†æ™‚çš„å‹•ç•«æ•ˆæœ */
			.form-group input:focus, 
			.form-group select:focus, 
			.form-group textarea:focus { 
				border-color: var(--accent-blue);
				background: white;
				box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.1); /* æ·¡æ·¡çš„ç™¼å…‰æ„Ÿ */
				transform: translateY(-1px); /* å¾®å¹…ä¸Šå‡æ„Ÿ */
			}

			/* è¡¨å–®ä¸¦æ’åˆ—çš„é–“è·èª¿æ•´ */
			.form-row {
				display: flex;
				gap: 15px; /* å¢åŠ å·¦å³ä¸¦æ’çš„é–“è· */
				margin-bottom: 0;
			}

			/* æ—…ä¼´ç®¡ç†æ¨™ç±¤ç¾åŒ– */
			#companion-list {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-bottom: 15px;
			}

			.companion-tag {
				display: flex;
				align-items: center;
				background: var(--light-blue);
				color: var(--deep-blue);
				padding: 6px 12px 6px 14px;
				border-radius: 50px; /* è† å›Šç‹€ */
				font-weight: 600;
				font-size: 0.9rem;
				border: 1px solid var(--primary-blue);
				transition: 0.2s;
			}

			.companion-tag:hover {
				background: #fff;
				box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			}

			.remove-btn {
				display: flex;
				align-items: center;
				justify-content: center;
				width: 20px;
				height: 20px;
				background: rgba(255, 77, 77, 0.1);
				color: #ff4d4d;
				border-radius: 50%;
				margin-left: 8px;
				cursor: pointer;
				font-size: 12px;
				transition: 0.2s;
			}

			.remove-btn:hover {
				background: #ff4d4d;
				color: white;
			}

			/* çµç®—çµ±è¨ˆè¡Œå„ªåŒ– */
			.balance-card-row {
				display: flex;
				align-items: center;
				padding: 16px;
				background: #fdfdfd;
				border: 1px solid #f0f4f8;
				border-radius: 14px;
				margin-bottom: 12px;
				transition: 0.3s;
			}

			.balance-card-row:hover {
				transform: scale(1.01);
				border-color: var(--primary-blue);
			}

			.balance-name {
				flex: 1;
				font-weight: bold;
				color: var(--deep-blue);
				font-size: 1.05rem;
			}

			.balance-amount {
				text-align: right;
				font-family: 'Monaco', 'Consolas', monospace; /* é‡‘é¡å°é½Šæ›´å¥½çœ‹ */
			}

			.status-label {
				font-size: 0.75rem;
				padding: 2px 8px;
				border-radius: 4px;
				margin-right: 10px;
				font-weight: bold;
			}
			/* ç¢ºä¿é è¨­æ˜¯é¡¯ç¤ºçš„ï¼Œä¸”ä½¿ç”¨ flex è®“å…§éƒ¨çš„ã€Œ+ã€è™Ÿå±…ä¸­ */
			.fab { 
				display: flex; 
				align-items: center; 
				justify-content: center;
				/* ... ä½ åŸæœ¬çš„å…¶ä»–æ¨£å¼ ... */
			}
    </style>
</head>
<body>

<div class="app-container">
    <header id="app-header">ğŸŒ¸ æ—…éŠè¡Œç¨‹</header>
    <div id="tabs-section" class="tabs-container"></div>
    <main id="main-content" class="content"></main>
    
    <nav class="bottom-nav">
        <button class="nav-item active" id="nav-itinerary" onclick="switchView('itinerary')"><span style="font-size:1.2rem;">ğŸ“…</span><span style="font-size:0.7rem;">è¡Œç¨‹</span></button>
        <button class="nav-item" id="nav-flight" onclick="switchView('flight')"><span style="font-size:1.2rem;">âœˆï¸</span><span style="font-size:0.7rem;">æ©Ÿç¥¨</span></button>
        <button class="nav-item" id="nav-hotel" onclick="switchView('hotel')"><span style="font-size:1.2rem;">ğŸ¨</span><span style="font-size:0.7rem;">é£¯åº—</span></button>
        <button class="nav-item" id="nav-wishlist" onclick="switchView('wishlist')"><span style="font-size:1.2rem;">âœ¨</span><span style="font-size:0.7rem;">é¡˜æœ›</span></button>
        <button class="nav-item" id="nav-expense" onclick="switchView('expense')"><span style="font-size:1.2rem;">ğŸ’°</span><span style="font-size:0.7rem;">è¨˜å¸³</span></button>
		<button class="nav-item" id="nav-admin" onclick="switchView('admin')"><span style="font-size:1.2rem;">âš™ï¸</span><span style="font-size:0.7rem;">ç®¡ç†</span></button>
    </nav>
    <button class="fab" onclick="openDynamicModal()">+</button>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content" id="modal-body"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>

	// For Firebase JS SDK v7.20.0 and later, measurementId is optional
	const firebaseConfig = {
		apiKey: "AIzaSyCHN4CC9UfqJQmjr01qlDigsbCuPGIqM_8",
		authDomain: "travel-planner-7f8db.firebaseapp.com",
		databaseURL: "https://travel-planner-7f8db-default-rtdb.firebaseio.com",
		projectId: "travel-planner-7f8db",
		storageBucket: "travel-planner-7f8db.firebasestorage.app",
		messagingSenderId: "7573524182",
		appId: "1:7573524182:web:04dd9dc4795b53a0bcc377",
		measurementId: "G-82KJWQY5RM"
	};

	// åˆå§‹åŒ– Firebase
	firebase.initializeApp(firebaseConfig);
	const db = firebase.database();
	// å–å¾—ç¶²å€åƒæ•¸ä¸­çš„ 'id'
	const urlParams = new URLSearchParams(window.location.search);
	const tripId = urlParams.get('id');
	// å¦‚æœç¶²å€æœ‰ ?id=xxxï¼Œå°±ç”¨ xxx ç•¶åç¨±ï¼›å¦å‰‡é è¨­ç”¨ 'travel_planner_default'
	const DB_REF = tripId ? `travel_planner_${tripId}` : 'travel_planner_default';

	var state; // å…ˆå®šç¾©ï¼Œä½†ä¸çµ¦å€¼


	// --- 2. ä¿®æ”¹è®€å–é‚è¼¯ï¼šå¾ Firebase æŠ“å–è³‡æ–™ ---
	// 3. ä¿®æ”¹å¾Œçš„åˆå§‹åŒ–å‡½å¼
	function initApp() {
		const mainContent = document.getElementById('main-content');
		
		// 1. å…ˆå¾ Firebase æŠ“è³‡æ–™
		db.ref(DB_REF).once('value').then((snapshot) => {
			const data = snapshot.val();
			
			// 2. ç¢ºå®šæŠ“åˆ°è³‡æ–™å¾Œï¼Œæ‰è³¦å€¼çµ¦ state
			if (data) {
				state = data;
			} else {
				// å¦‚æœé›²ç«¯æ²’è³‡æ–™ï¼Œçµ¦äºˆåˆå§‹ç¯„æœ¬
				state = getDefaultState();
			}

			// 3. âœ¨ é‡è¦ï¼šç¢ºå®š state æœ‰å€¼äº†ï¼Œæ‰èƒ½è¨­å®šå±¬æ€§
			state.isImporting = false; 

			// 4. æœ€å¾Œæ‰åŸ·è¡Œæ¸²æŸ“
			render(); 

		}).catch(error => {
			console.error("è®€å–å¤±æ•—:", error);
		});
	}


	// å°‡ä½ åŸæœ¬çš„å¤§å€å¡Š state ç‰©ä»¶å°è£æˆ functionï¼Œæ–¹ä¾¿ initApp å‘¼å«
	function getDefaultState() {
		return {
			"view": "itinerary",
			"dayIdx": 0,
			"itinerary": [
				{
				"title": "ç¯„ä¾‹æ—¥æœŸ Day 1ï¼šè¡Œç¨‹æ¨™é¡Œ",
				"spots": [
					{
					"name": "æ™¯é» A",
					"time": "10:00",
					"map": "http://maps.google.com/example1",
					"link": "http://example.com/A",
					"note": "å‚™è¨»èªªæ˜æ–‡å­—",
					"expenses": [
						{
						"item": "æ”¯å‡ºé …ç›® X",
						"amount": 1000,
						"currency": "JPY",
						"paidBy": "æ—…ä¼´ A",
						"sharedWith": [
							"æ—…ä¼´ A",
							"æ—…ä¼´ B"
						]
						}
					],
					"checklist": [
						{
						"text": "å¾…è¾¦äº‹é … 1",
						"completed": true
						},
						{
						"text": "å¾…è¾¦äº‹é … 2",
						"completed": false
						}
					]
					}
				]
				}
			],
			"flights": [
				{
				"airline": "èˆªç©ºå…¬å¸åç¨±",
				"flightNo": "èˆªç­ç·¨è™Ÿ",
				"from": "å‡ºç™¼åœ°",
				"to": "ç›®çš„åœ°",
				"depTime": "00:00"
				}
			],
			"hotels": [
				{
				"name": "é£¯åº—åç¨±",
				"checkIn": "YYYY-MM-DD",
				"map": "http://maps.google.com/hotel",
				"link": "é ç´„ä»£ç¢¼æˆ–é€£çµ",
				"note": "é£¯åº—ç›¸é—œå‚™è¨»"
				}
			],
			"wishlist": [
				{
				"name": "é¡˜æœ›æ¸…å–®åœ°é»/ç‰©å“ 1",
				"time": "",
				"map": "http://maps.google.com/wish1",
				"link": "http://example.com/wish1",
				"note": "é è¨ˆè³¼è²·æˆ–å‰å¾€çš„å‚™è¨»",
				"expenses": [
					{
					"item": "é ä¼°æ”¯å‡ºé …ç›®",
					"amount": 500,
					"currency": "JPY",
					"paidBy": "æ—…ä¼´ A",
					"sharedWith": [
						"æ—…ä¼´ A"
					]
					}
				],
				"checklist": [
					{
					"text": "ç´°é …æ¸…å–® 1",
					"completed": false
					}
				]
				}
			],
			"companions": [
				"æ—…ä¼´ A",
				"æ—…ä¼´ B"
			],
			"isImporting": false,
			"editTarget": null
			};
	}

    // ç¢ºä¿é‹è¡Œæ™‚ç‹€æ…‹æ­£ç¢º
    //state.isImporting = false;
    //if (!state.view) state.view = 'itinerary';

    // 4. ä¿®æ”¹å„²å­˜åŠŸèƒ½ï¼šåŒæ™‚å­˜æœ¬åœ°èˆ‡é›²ç«¯
	let timeout;
	function save() {
		if (!state) return; // é˜²æ­¢ state ç‚ºç©ºæ™‚å ±éŒ¯
		
		// å­˜æœ¬åœ°å‚™ä»½
		localStorage.setItem(DB_REF, JSON.stringify(state));
		

		// 2. åˆ¤æ–·æ˜¯å¦ç‚ºé è¨­è·¯å¾‘
		if (DB_REF === 'travel_planner_default') {
			console.log("ğŸ“ ç›®å‰ç‚ºé è¨­æ¨¡å¼ï¼Œè³‡æ–™åƒ…å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ã€‚");
			return; // ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œä¸‹æ–¹çš„é›²ç«¯åŒæ­¥é‚è¼¯
		}
		// å­˜é›²ç«¯
		clearTimeout(timeout);
		timeout = setTimeout(() => {
        db.ref(DB_REF).set(state)
            .then(() => console.log(`â˜ï¸ é›²ç«¯åŒæ­¥æˆåŠŸ: ${DB_REF}`))
            .catch(e => console.error("é›²ç«¯åŒæ­¥å¤±æ•—:", e));
    	}, 2000);
	}

    function render() {
        renderTabs();
        renderContent();
        updateNav();
        save();
    }

    function renderTabs() {
		var container = document.getElementById('tabs-section');
		container.innerHTML = '';
		if (state.view !== 'itinerary') { container.classList.add('hidden'); return; }
		container.classList.remove('hidden');
		
		for (var i = 0; i < state.itinerary.length; i++) {
			(function(idx){
				var btn = document.createElement('button');
				btn.className = (idx === state.dayIdx) ? 'tab active' : 'tab';
				btn.innerText = state.itinerary[idx].title;
				btn.onclick = function() { state.dayIdx = idx; render(); };
				container.appendChild(btn);
			})(i);
		}
		
		var addDay = document.createElement('button');
		addDay.className = 'tab';
		addDay.innerText = '+';
		addDay.style.border = "1px dashed var(--accent-blue)";
		addDay.onclick = function() {
			state.itinerary.push({ title: 'Day ' + (state.itinerary.length + 1), spots: [] });
			state.dayIdx = state.itinerary.length - 1;
			render();
		};
		container.appendChild(addDay);
	}

    function renderContent() {
		var main = document.getElementById('main-content');
		main.innerHTML = '';
		var view = state.view;

		// 1. æ¨™é¡Œè™•ç†
		var headerTitle = '';
		if (view === 'itinerary') headerTitle = 'ğŸŒ¸ æ—…éŠè¡Œç¨‹';
		else if (view === 'flight') headerTitle = 'âœˆï¸ æ©Ÿç¥¨è³‡è¨Š';
		else if (view === 'hotel') headerTitle = 'ğŸ¨ é£¯åº—ä½å®¿';
		else if (view === 'wishlist') headerTitle = 'âœ¨ é¡˜æœ›æ¸…å–®';
		else if (view === 'expense') headerTitle = 'ğŸ’° çµç®—ä¸­å¿ƒ';
		else if (view === 'admin') headerTitle = 'âš™ï¸ ç®¡ç†ä»‹é¢';
		document.getElementById('app-header').innerText = headerTitle;

		if (view === 'expense') {
			renderExpensePage();
			return;
		}
		if (view === 'admin') {
			renderAdminPage();
			return;
		}

		// 2. è¡Œç¨‹è¦–åœ–ç‰¹æœ‰çš„ï¼šé ‚éƒ¨ç®¡ç†åˆ— (ç·¨è¼¯åç¨±èˆ‡åˆªé™¤)
		// ä¿®æ”¹ renderContent è£¡é¢çš„é€™æ®µï¼š
		if (view === 'itinerary') {
			var dayControl = document.createElement('div');
			dayControl.style.cssText = "display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding:0 5px;";
			
			// å·¦å´ï¼šé¡¯ç¤ºåç¨±èˆ‡ç·¨è¼¯æŒ‰éˆ•
			var leftSide = document.createElement('div');
			// ä½¿ç”¨ cssText å°±ä¸æœƒå‡ºéŒ¯ï¼
			leftSide.style.cssText = "display:flex; align-items:center; gap:8px;"; 
			leftSide.innerHTML = '<span style="font-size:1rem; font-weight:bold; color:var(--deep-blue);">' + state.itinerary[state.dayIdx].title + '</span>' +
								 '<button onclick="editDayTitle('+state.dayIdx+')" style="background:none; border:none; cursor:pointer; font-size:1rem; color:var(--accent-blue); padding:0;">âœï¸</button>';
			
			// å³å´ï¼šåˆªé™¤æŒ‰éˆ•
			var rightSide = document.createElement('div');
			if (state.itinerary.length > 1) {
				rightSide.innerHTML = '<button onclick="handleDeleteDay('+state.dayIdx+')" style="background:none; border:1px solid #ff4d4f; color:#ff4d4f; padding:4px 10px; border-radius:6px; cursor:pointer; font-size:0.85rem; display:flex; align-items:center; gap:4px;">' +
									  'ğŸ—‘ï¸ åˆªé™¤é€™å¤©</button>';
			}

			dayControl.appendChild(leftSide);
			dayControl.appendChild(rightSide);
			main.appendChild(dayControl);
		}

		// 3. è³‡æ–™ç²å–èˆ‡å¡ç‰‡æ¸²æŸ“
		var data = (view === 'itinerary') ? state.itinerary[state.dayIdx].spots : 
				   (view === 'wishlist') ? state.wishlist : 
				   (view === 'flight') ? state.flights : state.hotels;

		for (var i = 0; i < data.length; i++) {
			if (view === 'flight') main.appendChild(createFlightCard(data[i], i));
			else if (view === 'hotel') main.appendChild(createHotelCard(data[i], i));
			else main.appendChild(createSpotCard(data[i], i, view === 'wishlist'));
		}

		// å¦‚æœç•¶å¤©æ²’è¡Œç¨‹ï¼Œé¡¯ç¤ºä¸€å€‹æº«é¦¨æç¤º
		if (data.length === 0 && view === 'itinerary') {
			var emptyHint = document.createElement('div');
			emptyHint.style.cssText = "text-align:center; padding:40px 20px; color:#ccc; border:2px dashed #eee; border-radius:15px; margin-top:10px;";
			emptyHint.innerHTML = 'ğŸ“… é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹å–”<br><span style="font-size:0.8rem;">é»æ“Šå³ä¸‹è§’ + é–‹å§‹æ–°å¢</span>';
			main.appendChild(emptyHint);
		}
	}
	
	// è½‰ç§»æ™¯é»åˆ°å…¶ä»–å¤©æ•¸
	function openTransferModal(spotIdx) {
		if (state.itinerary.length <= 1) {
			alert('åªæœ‰ä¸€å¤©è¡Œç¨‹ï¼Œç„¡æ³•è½‰ç§»ï¼');
			return;
		}
		
		var spot = state.itinerary[state.dayIdx].spots[spotIdx];
		var currentDayTitle = state.itinerary[state.dayIdx].title;
		
		// å»ºç«‹é¸æ“‡ä»‹é¢
		var options = '';
		for (var i = 0; i < state.itinerary.length; i++) {
			if (i !== state.dayIdx) { // æ’é™¤ç•¶å‰å¤©æ•¸
				options += '<option value="' + i + '">' + state.itinerary[i].title + '</option>';
			}
		}
		
		var html = '<div style="padding: 20px;">' +
				   '<h3 style="margin-top:0; color:var(--deep-blue);">ğŸ”„ è½‰ç§»æ™¯é»</h3>' +
				   '<p style="color:#666; font-size:0.9rem;">å°‡ã€Œ' + spot.name + 'ã€å¾ã€Œ' + currentDayTitle + 'ã€è½‰ç§»åˆ°ï¼š</p>' +
				   '<select id="transfer-target-day" style="width:100%; padding:12px; border-radius:10px; border:1.5px solid var(--primary-blue); font-size:1rem; margin-bottom:20px;">' +
				   options +
				   '</select>' +
				   '<div style="display:flex; gap:12px;">' +
				   '<button onclick="closeModal()" style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff; color:var(--text-main); font-weight:bold; cursor:pointer;">å–æ¶ˆ</button>' +
				   '<button onclick="executeTransfer(' + spotIdx + ')" style="flex:1.5; padding:12px; border:none; border-radius:12px; background:var(--accent-blue); color:white; font-weight:bold; cursor:pointer; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);">ç¢ºèªè½‰ç§»</button>' +
				   '</div>' +
				   '</div>';
		
		document.getElementById('modal-body').innerHTML = html;
		document.getElementById('edit-modal').style.display = 'flex';
	}
	
	function executeTransfer(spotIdx) {
		var targetDayIdx = parseInt(document.getElementById('transfer-target-day').value);
		var spot = state.itinerary[state.dayIdx].spots[spotIdx];
		
		// ç§»é™¤åŸä½ç½®
		state.itinerary[state.dayIdx].spots.splice(spotIdx, 1);
		
		// åŠ å…¥æ–°ä½ç½®
		state.itinerary[targetDayIdx].spots.push(spot);
		
		closeModal();
		alert('âœ… å·²æˆåŠŸè½‰ç§»åˆ°ã€Œ' + state.itinerary[targetDayIdx].title + 'ã€ï¼');
		render();
	}

	function handleDeleteDay(idx) {
		if (confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹ã€Œ' + state.itinerary[idx].title + 'ã€å—ï¼Ÿ\nå…§å®¹åˆªæ‰å¾Œå°±ç„¡æ³•æ‰¾å›å–”ï¼')) {
			state.itinerary.splice(idx, 1);
			
			// é‡æ–°æ’åº Day æ¨™é¡Œ
			for (var i = 0; i < state.itinerary.length; i++) {
				state.itinerary[i].title = 'Day ' + (i + 1);
			}

			// èª¿æ•´ç•¶å‰æª¢è¦–çš„ index (é˜²æ­¢æº¢å‡º)
			if (state.dayIdx >= state.itinerary.length) {
				state.dayIdx = state.itinerary.length - 1;
			} else if (state.dayIdx > 0) {
				state.dayIdx = state.dayIdx - 1; // åˆªé™¤å¾Œè·³è½‰åˆ°å‰ä¸€å¤©ï¼Œé«”é©—è¼ƒå¥½
			}
			
			save();
			render();
		}
	}
    // --- å¡ç‰‡ç”Ÿæˆ (å«åˆªé™¤æŒ‰éˆ•) ---
    function createSpotCard(spot, index, isWish) {
		var div = document.createElement('div');
		div.className = 'spot-card';
		
		// 1. ç”Ÿæˆé€£çµæŒ‰éˆ• (Google Map & å®˜ç¶²)
		var linkHTML = '';
		if (spot.map || spot.link) {
			linkHTML += '<div style="margin-top:8px; display:flex; gap:10px;">';
			if (spot.map) {
				linkHTML += '<a href="' + spot.map + '" target="_blank" style="text-decoration:none; font-size:0.8rem; color:var(--accent-blue); display:flex; align-items:center; gap:3px;">ğŸ“ åœ°åœ–å°èˆª</a>';
			}
			if (spot.link) {
				linkHTML += '<a href="' + spot.link + '" target="_blank" style="text-decoration:none; font-size:0.8rem; color:var(--accent-blue); display:flex; align-items:center; gap:3px;">ğŸ”— å®˜æ–¹ç¶²ç«™</a>';
			}
			linkHTML += '</div>';
		}

		// 2. ç”Ÿæˆå¾…è²·æ¸…å–®é è¦½
		var ckHTML = '';
		if (spot.checklist && spot.checklist.length > 0) {
			ckHTML += '<div style="margin-top:10px; border-top:1px dashed #eee; padding-top:8px;">';
			for (var j = 0; j < spot.checklist.length; j++) {
				var item = spot.checklist[j];
				var isChecked = item.completed ? 'checked' : '';
				var textStyle = item.completed ? 'text-decoration:line-through; color:#ccc;' : '';
				ckHTML += '<div style="font-size:0.85rem; display:flex; align-items:center; margin-bottom:3px;">' +
						'<input type="checkbox" ' + isChecked + ' onclick="toggleCheckItem('+index+','+j+','+isWish+')"> ' +
						'<span style="'+textStyle+'">' + item.text + '</span></div>';
			}
			ckHTML += '</div>';
		}

		// 3. ç”Ÿæˆæ”¯å‡ºé è¦½
		var exHTML = '';
		if (spot.expenses && spot.expenses.length > 0) {
			var total = 0;
			for (var k = 0; k < spot.expenses.length; k++) total += parseFloat(spot.expenses[k].amount || 0);
			exHTML = '<div style="font-size:0.8rem; color:var(--accent-blue); font-weight:bold; margin-top:5px;">ğŸ’° å…±è¨ˆ: ' + Math.round(total) + ' (é»æ“Šç·¨è¼¯æŸ¥çœ‹æ˜ç´°)</div>';
		}

		// 4. çµ„åˆæœ€çµ‚ HTML
		div.innerHTML = '<div class="card-time">' + (spot.time || '--:--') + '</div>' +
						'<div class="card-title">' + spot.name + '</div>' +
						'<div style="font-size:0.85rem; color:#777; line-height:1.4;">' + (spot.note || '') + '</div>' +
						linkHTML +  // æ’å…¥åœ°åœ–èˆ‡é€£çµæŒ‰éˆ•
						ckHTML + 
						exHTML +
						'<div class="card-actions">' +
						(isWish ? '<button onclick="state.isImporting=true; openDynamicModal('+index+')">ğŸ“…åŒ¯å…¥</button>' : '<button onclick="openTransferModal('+index+')">ğŸ”„è½‰ç§»</button>') +
						'<button onclick="state.isImporting=false; openDynamicModal('+index+')">âœï¸</button>' +
						'<button onclick="handleDelete('+index+', '+isWish+')">ğŸ—‘ï¸</button>' +
						'</div>';
		return div;
	}

	// å¿«é€Ÿå‹¾é¸åŠŸèƒ½
	function toggleCheckItem(spotIdx, itemIdx, isWish) {
		var data = isWish ? state.wishlist[spotIdx] : state.itinerary[state.dayIdx].spots[spotIdx];
		data.checklist[itemIdx].completed = !data.checklist[itemIdx].completed;
		save();
		render();
	}

    function createFlightCard(f, i) {
		var div = document.createElement('div');
		div.className = 'flight-card';
		
		// å…§éƒ¨ HTML çµæ§‹å„ªåŒ–ï¼šå€åˆ†ç‚º æ¨™é ­(èˆªç­è™Ÿ)ã€ä¸»é«”(æ©Ÿå ´èˆ‡é£›æ©Ÿ)ã€åº•éƒ¨(æ™‚é–“èˆ‡æŒ‰éˆ•)
		div.innerHTML = 
			// 1. èˆªç­è³‡è¨Šæ¨™é ­
			'<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px dashed rgba(255,255,255,0.2); padding-bottom:10px;">' +
				'<span style="font-weight:bold; font-size:0.9rem; letter-spacing:1px; color:var(--primary-blue);">' + (f.airline || 'èˆªç©ºå…¬å¸') + '</span>' +
				'<span style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:6px; font-size:0.75rem;">' + (f.flightNo || 'èˆªç­è™Ÿ') + '</span>' +
			'</div>' +
			
			// 2. å‡ºç™¼ âœˆï¸ æŠµé” (å·¦å³å¤§å­—ä½ˆå±€)
			'<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">' +
				'<div style="text-align:left;">' +
					'<div style="font-size:1.6rem; font-weight:bold; color:#fff;">' + (f.from || '---') + '</div>' +
					'<div style="font-size:0.7rem; opacity:0.6;">DEPARTURE</div>' +
				'</div>' +
				'<div style="flex:1; text-align:center; position:relative; display:flex; align-items:center; justify-content:center; padding:0 15px;">' +
					'<div style="width:100%; border-top:1px dashed rgba(255,255,255,0.3); position:absolute; top:50%;"></div>' +
					'<span style="background:var(--flight-navy); z-index:1; padding:0 8px; font-size:1.2rem;">âœˆï¸</span>' +
				'</div>' +
				'<div style="text-align:right;">' +
					'<div style="font-size:1.6rem; font-weight:bold; color:#fff;">' + (f.to || '---') + '</div>' +
					'<div style="font-size:0.7rem; opacity:0.6;">ARRIVAL</div>' +
				'</div>' +
			'</div>' +

			// 3. åº•éƒ¨ï¼šèµ·é£›æ™‚é–“èˆ‡æ“ä½œæŒ‰éˆ•
			'<div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">' +
				'<div>' +
					'<div style="font-size:0.9rem; color:var(--primary-blue); font-weight:bold;">' + (f.depTime || '--:--') + '</div>' +
					'<div style="font-size:0.75rem; opacity:0.6;">SCHEDULED</div>' +
				'</div>' +
				'<div class="card-actions" style="position:static; display:flex; gap:8px;">' +
					'<button onclick="openDynamicModal('+i+')" style="background:rgba(255,255,255,0.15); border:none; color:white; padding:6px 10px; border-radius:8px; cursor:pointer;">âœï¸</button>' +
					'<button onclick="handleDeleteFlight('+i+')" style="background:rgba(255,255,255,0.15); border:none; color:white; padding:6px 10px; border-radius:8px; cursor:pointer;">ğŸ—‘ï¸</button>' +
				'</div>' +
			'</div>';
			
		return div;
	}

    function createHotelCard(h, i) {
		var div = document.createElement('div');
		div.className = 'hotel-card';
		
		// å»ºç«‹å¤–éƒ¨é€£çµçš„ HTML (å¦‚æœæœ‰å¡«å¯«çš„è©±)
		var mapHtml = h.map ? 
			'<a href="' + h.map + '" target="_blank" class="card-link">ğŸ“ åœ°åœ–å°èˆª</a>' : '';
		var linkHtml = h.link ? 
			'<div style="font-size:0.85rem; color:var(--accent-blue); margin-top:8px; word-break:break-all;">' +
			'ğŸ”‘ è¨‚æˆ¿è³‡è¨Š: <span style="font-weight:bold;">' + h.link + '</span></div>' : '';

		div.innerHTML = 
			// æ¨™é¡Œèˆ‡æ“ä½œæŒ‰éˆ•
			'<div style="margin-right: 60px;">' +
				'<div class="card-title" style="font-size:1.2rem; margin-bottom:4px;">ğŸ¨ ' + (h.name || 'é£¯åº—åç¨±') + '</div>' +
				'<div style="font-size:0.85rem; color:var(--text-main); opacity:0.8;">ğŸ“… å…¥ä½æ—¥æœŸ: ' + (h.checkIn || 'æœªå¡«å¯«') + '</div>' +
			'</div>' +
			
			// é£¯åº—å‚™è¨» (å¦‚æœ‰å¡«å¯«æ‰é¡¯ç¤º)
			(h.note ? '<div style="margin-top:10px; font-size:0.85rem; color:#718096; background:#f7fafc; padding:8px; border-radius:8px;">' + h.note + '</div>' : '') +
			
			// é€£çµå€åŸŸ
			'<div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">' +
				mapHtml +
				linkHtml +
			'</div>' +

			// æ“ä½œæŒ‰éˆ•
			'<div class="card-actions">' +
				'<button onclick="openDynamicModal('+i+')">âœï¸</button>' +
				'<button onclick="handleDeleteHotel('+i+')">ğŸ—‘ï¸</button>' +
			'</div>';
			
		return div;
	}

    // --- Modal é‚è¼¯ ---
    function openDynamicModal(index) {
		var idx = (index !== undefined) ? index : null;
		var container = document.getElementById('modal-body');
		state.editTarget = (idx !== null) ? { index: idx, view: state.view } : null;
		
		// æ¨™é¡Œèˆ‡é¢¨æ ¼çµ±ä¸€
		var title = (idx !== null ? 'âœï¸ ç·¨è¼¯é …ç›®' : 'â• æ–°å¢é …ç›®');
		var html = '<div class="modal-header" style="color:var(--deep-blue); border-bottom: 2px solid var(--light-blue); padding-bottom: 15px; margin-bottom: 20px;">' + title + '</div>';

		if (state.view === 'flight') {
			html += '<div class="form-group"><label>èˆªç©ºå…¬å¸</label><input type="text" id="fl-airline" placeholder="ä¾‹å¦‚ï¼šé•·æ¦®èˆªç©º"></div>' +
					'<div class="form-row">' +
						'<div class="form-group"><label>èˆªç­è™Ÿç¢¼</label><input type="text" id="fl-no" placeholder="BR198"></div>' +
						'<div class="form-group"><label>æ™‚é–“</label><input type="text" id="fl-time" placeholder="12/23 08:30"></div>' +
					'</div>' +
					'<div class="form-row">' +
						'<div class="form-group"><label>å‡ºç™¼åœ°</label><input type="text" id="fl-from" placeholder="TPE"></div>' +
						'<div class="form-group"><label>ç›®çš„åœ°</label><input type="text" id="fl-to" placeholder="NRT"></div>' +
					'</div>' +
					'<div class="form-row">' +
						'<div class="form-group"><label>èˆªå»ˆ/ç™»æ©Ÿé–€</label><input type="text" id="fl-gate"></div>' +
						'<div class="form-group"><label>åº§ä½è™Ÿç¢¼</label><input type="text" id="fl-seat"></div>' +
					'</div>';
		} else if (state.view === 'hotel') {
			html += '<div class="form-group"><label>é£¯åº—åç¨± *</label><input type="text" id="ht-name"></div>' +
					'<div class="form-group"><label>å…¥ä½æ—¥æœŸ</label><input type="date" id="ht-checkin"></div>' +
					'<div class="form-group"><label>Google Map é€£çµ</label><input type="url" id="ht-map" placeholder="è²¼ä¸Šåœ°åœ–é€£çµ"></div>' +
					'<div class="form-group"><label>è¨‚æˆ¿ç¢ºèªç¢¼/å®˜ç¶²é€£çµ</label><input type="text" id="ht-link"></div>' +
					'<div class="form-group"><label>å‚™è¨»</label><textarea id="ht-note" rows="3" style="resize:none;"></textarea></div>';
		} else {
			// æ™¯é» / é¡˜æœ›æ¸…å–®
			html += '<div class="form-group"><label>åç¨± *</label><input type="text" id="f-name"></div>' +
					'<div class="form-row">' +
						'<div class="form-group" style="flex: 0.4;"><label>æ™‚é–“</label><input type="time" id="f-time"></div>' +
						'<div class="form-group" style="flex: 0.6;"><label>åœ°åœ–é€£çµ</label><input type="url" id="f-map" placeholder="ğŸ“ Google Map"></div>' +
					'</div>' +
					'<div class="form-group"><label>å®˜æ–¹ç¶²ç«™/é€£çµ</label><input type="url" id="f-link" placeholder="ğŸ”— ç¶²ç«™é€£çµ"></div>' +
					'<div class="form-group"><label>ğŸ’° è¨˜å¸³æ˜ç´°</label><div id="m-expense-list"></div><button class="btn-add" onclick="addExRow()">+ æ–°å¢æ”¯å‡ºé …ç›®</button></div>' +
					'<div class="form-group"><label>ğŸ›ï¸ å¾…è²·æ¸…å–®</label><div id="m-check-list"></div><button class="btn-add" onclick="addCkRow()">+ æ–°å¢å‹¾é¸é …ç›®</button></div>' +
					'<div class="form-group"><label>å‚™è¨»</label><textarea id="f-note" rows="2" style="resize:none;"></textarea></div>';
			
			if (state.isImporting) {
				html += '<div style="margin-top: 15px; padding: 15px; background: var(--light-blue); border-radius: 12px; border: 1px solid var(--primary-blue);">' +
						'<label style="display:block; margin-bottom:8px; font-weight:bold; color:var(--deep-blue);">ğŸ“… åŒ¯å…¥è‡³å“ªä¸€å¤©ï¼Ÿ</label>' +
						'<select id="f-target-day" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--primary-blue);">';
				for (var i=0; i<state.itinerary.length; i++) {
					html += '<option value="'+i+'">'+state.itinerary[i].title+'</option>';
				}
				html += '</select></div>';
			}
		}

		// åº•éƒ¨æŒ‰éˆ•å€å¡Š
		html += '<div style="display:flex; gap:12px; margin-top:25px;">' +
				'<button style="flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff; color:var(--text-main); font-weight:bold; cursor:pointer;" onclick="closeModal()">å–æ¶ˆ</button>' +
				'<button style="flex:1.5; padding:12px; border:none; border-radius:12px; background:var(--accent-blue); color:white; font-weight:bold; cursor:pointer; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);" onclick="handleDynamicSave()">å„²å­˜è³‡æ–™</button>' +
				'</div>';

		container.innerHTML = html;
		if (idx !== null) fillData(state.view, idx);
		document.getElementById('edit-modal').style.display = 'flex';
	}

    function addExRow(data) {
		var container = document.getElementById('m-expense-list');
		var div = document.createElement('div');
		div.className = 'expense-edit-item';
		div.style.cssText = "border: 1px solid #eee; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06);";

		var payerOptions = '';
		for (var i = 0; i < state.companions.length; i++) {
			var name = state.companions[i];
			var selected = (data && data.paidBy === name) ? 'selected' : '';
			payerOptions += '<option value="' + name + '" ' + selected + '>' + name + '</option>';
		}

		// åˆ†æ”¤è€…å€å¡Šï¼šéš±è— checkboxï¼Œé»æ“Šæ•´å€‹ label è®Šè‰²
		var sharerHTML = '<div style="margin-top:12px;"><div style="font-size:0.8rem; font-weight:bold; color:#888; margin-bottom:8px;">èª°è¦åˆ†æ”¤é€™ç­†éŒ¢ï¼Ÿ</div><div class="sharer-container" style="display:flex; flex-wrap:wrap; gap:8px;">';
		for (var j = 0; j < state.companions.length; j++) {
			var cName = state.companions[j];
			var isChecked = (!data || (data.sharedWith && data.sharedWith.indexOf(cName) !== -1)) ? 'checked' : '';
			
			sharerHTML += '<label class="sharer-label">' +
						  '<input type="checkbox" class="ex-sharer" value="' + cName + '" ' + isChecked + '> ' +
						  '<span>' + cName + '</span>' + 
						  '</label>';
		}
		sharerHTML += '</div></div>';

		div.innerHTML = 
			'<div style="display:grid; grid-template-columns: 2fr 1fr 0.8fr; gap:8px; margin-bottom:12px;">' +
				'<input type="text" class="ex-item" placeholder="æ”¯å‡ºé …ç›®" style="padding:8px; border-radius:6px; border:1px solid #ddd;" value="' + (data ? data.item : '') + '">' +
				'<input type="number" class="ex-amt" placeholder="é‡‘é¡" style="padding:8px; border-radius:6px; border:1px solid #ddd;" value="' + (data ? data.amount : '') + '">' +
				'<select class="ex-cur" style="padding:8px; border-radius:6px; border:1px solid #ddd;"><option value="TWD" '+(data&&data.currency==='TWD'?'selected':'')+'>TWD</option><option value="JPY" '+(data&&data.currency==='JPY'?'selected':'')+'>JPY</option></select>' +
			'</div>' +
			'<div style="font-size:0.9rem; display:flex; align-items:center; gap:8px;">' +
				'<b>ç”±èª°ä»˜æ¬¾:</b> <select class="ex-payer" style="padding:5px 10px; border-radius:6px; border:1px solid #ccc;">' + payerOptions + '</select>' +
			'</div>' +
			sharerHTML +
			'<button onclick="this.parentElement.remove()" style="position:absolute; top:10px; right:10px; border:none; background:none; color:#ccc; font-size:1.2rem; cursor:pointer;">âœ•</button>';
		
		container.appendChild(div);
	}
    function addCkRow(text) {
        var div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = '<input type="text" class="ck-text" placeholder="å“é …" style="flex:1;" value="'+(text||'')+'">' +
                        '<button onclick="this.parentElement.remove()" style="border:none; background:none; color:red;">âœ•</button>';
        document.getElementById('m-check-list').appendChild(div);
    }

    function fillData(view, idx) {
        if (view === 'flight') {
            var d = state.flights[idx];
            document.getElementById('fl-airline').value = d.airline||'';
            document.getElementById('fl-no').value = d.flightNo||'';
            document.getElementById('fl-time').value = d.depTime||'';
            document.getElementById('fl-from').value = d.from||'';
            document.getElementById('fl-to').value = d.to||'';
            document.getElementById('fl-gate').value = d.gate||'';
            document.getElementById('fl-seat').value = d.seat||'';
        } else if (view === 'hotel') {
            var d = state.hotels[idx];
            document.getElementById('ht-name').value = d.name||'';
            document.getElementById('ht-checkin').value = d.checkIn||'';
            document.getElementById('ht-map').value = d.map||'';
            document.getElementById('ht-link').value = d.link||'';
            document.getElementById('ht-note').value = d.note||'';
        } else {
            var d = (view === 'wishlist') ? state.wishlist[idx] : state.itinerary[state.dayIdx].spots[idx];
            document.getElementById('f-name').value = d.name||'';
            document.getElementById('f-time').value = d.time||'';
            document.getElementById('f-map').value = d.map||'';
            document.getElementById('f-link').value = d.link||'';
            document.getElementById('f-note').value = d.note||'';
            if (d.expenses) d.expenses.forEach(function(e){ addExRow(e); });
            if (d.checklist) d.checklist.forEach(function(c){ addCkRow(c.text); });
        }
    }

    function handleDynamicSave() {
        var view = state.view;
        var target = state.editTarget;
        var obj = {};

        if (view === 'flight') {
            obj = {
                airline: document.getElementById('fl-airline').value,
                flightNo: document.getElementById('fl-no').value,
                depTime: document.getElementById('fl-time').value,
                from: document.getElementById('fl-from').value,
                to: document.getElementById('fl-to').value,
                gate: document.getElementById('fl-gate').value,
                seat: document.getElementById('fl-seat').value
            };
            if (target) state.flights[target.index] = obj; else state.flights.push(obj);
        } else if (view === 'hotel') {
            obj = {
                name: document.getElementById('ht-name').value,
                checkIn: document.getElementById('ht-checkin').value,
                map: document.getElementById('ht-map').value,
                link: document.getElementById('ht-link').value,
                note: document.getElementById('ht-note').value
            };
            if (target) state.hotels[target.index] = obj; else state.hotels.push(obj);
        } else {
            // 1. ä¿®æ”¹è¨˜å¸³è³‡æ–™æ”¶é›†ï¼šåŠ å…¥ä»˜æ¬¾äºº (paidBy)
            var exArr = [];
            var exRows = document.querySelectorAll('#m-expense-list .expense-edit-item');
            exRows.forEach(function(row) {
                var amt = row.querySelector('.ex-amt').value;
                if (amt) {
                    // æ”¶é›†è©²ç­†æ”¯å‡ºè¢«å‹¾é¸çš„åˆ†æ”¤è€…
                    var selectedSharers = [];
                    var sharerCheckboxes = row.querySelectorAll('.ex-sharer:checked');
                    sharerCheckboxes.forEach(function(cb) {
                        selectedSharers.push(cb.value);
                    });

                    // å¦‚æœå®Œå…¨æ²’å‹¾ï¼Œè‡ªå‹•é è¨­ç”±ä»˜æ¬¾äººè‡ªå·±æ‰¿æ“” (é˜²æ­¢é™¤ä»¥ 0)
                    if (selectedSharers.length === 0) {
                        selectedSharers.push(row.querySelector('.ex-payer').value);
                    }

                    exArr.push({ 
                        item: row.querySelector('.ex-item').value, 
                        amount: parseFloat(amt), 
                        currency: row.querySelector('.ex-cur').value,
                        paidBy: row.querySelector('.ex-payer').value,
                        sharedWith: selectedSharers // å„²å­˜å‹¾é¸çš„äººå“¡åå–®
                    });
                }
            });

            // 2. ä¿®æ”¹å¾…è²·æ¸…å–®æ”¶é›†ï¼šé˜²æ­¢ç·¨è¼¯æ™‚ completed ç‹€æ…‹è¢«æ´—æ‰
            var ckArr = [];
            var ckRows = document.querySelectorAll('#m-check-list .item-row');
            ckRows.forEach(function(row) {
                var text = row.querySelector('.ck-text').value;
                if (text) {
                    // é€™è£¡åŠ ä¸Šä¸€å€‹åˆ¤æ–·ï¼Œå¦‚æœæ˜¯ç·¨è¼¯ç¾æœ‰é …ç›®ï¼Œå˜—è©¦ä¿ç•™åŸæœ¬çš„å‹¾é¸ç‹€æ…‹
                    // (é€™éƒ¨åˆ†å¦‚æœæ¯”è¼ƒè¤‡é›œï¼Œæœ€ç°¡å–®æ˜¯å…ˆæŠ“ text å°±å¥½)
                    ckArr.push({ text: text, completed: false }); 
                }
            });

            // 3. çµ„åˆç‰©ä»¶ (é€™éƒ¨åˆ†ç¶­æŒä½ çš„çµæ§‹)
            obj = {
                name: document.getElementById('f-name').value,
                time: document.getElementById('f-time').value,
                map: document.getElementById('f-map').value,
                link: document.getElementById('f-link').value,
                note: document.getElementById('f-note').value,
                expenses: exArr,
                checklist: ckArr
            };

            if (state.isImporting) {
                var day = document.getElementById('f-target-day').value;
                state.itinerary[day].spots.push(obj);
                state.isImporting = false;
            } else if (target) {
                if (view === 'itinerary') state.itinerary[state.dayIdx].spots[target.index] = obj;
                else state.wishlist[target.index] = obj;
            } else {
                if (view === 'itinerary') state.itinerary[state.dayIdx].spots.push(obj);
                else state.wishlist.push(obj);
            }
        }
        closeModal(); render();
    }

    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    function switchView(v) {
    	state.view = v;
		render();
		
		// å–å¾—å³ä¸‹è§’çš„åŠ è™ŸæŒ‰éˆ• (FAB)
		var fab = document.querySelector('.fab');
		if (fab) {
			// å¦‚æœæ˜¯è¨˜å¸³é é¢ (expense)ï¼Œå°±éš±è—ï¼›å¦å‰‡é¡¯ç¤º
			if (v === 'expense' || v === 'admin') {
				fab.classList.add('hidden');
			} else {
				fab.classList.remove('hidden');
			}
		}
	}
    function updateNav() {
        var items = document.querySelectorAll('.nav-item');
        items.forEach(function(n){ n.classList.remove('active'); });
        document.getElementById('nav-' + state.view).classList.add('active');
    }

    // åˆªé™¤é‚è¼¯
    function handleDelete(idx, isWish) { if(confirm('åˆªé™¤é …ç›®ï¼Ÿ')) { if(isWish) state.wishlist.splice(idx, 1); else state.itinerary[state.dayIdx].spots.splice(idx, 1); render(); } }
    function handleDeleteFlight(idx) { if(confirm('åˆªé™¤æ©Ÿç¥¨ï¼Ÿ')) { state.flights.splice(idx, 1); render(); } }
    function handleDeleteHotel(idx) { if(confirm('åˆªé™¤é£¯åº—ï¼Ÿ')) { state.hotels.splice(idx, 1); render(); } }
	// --- è¨˜å¸³çµç®—é é¢ ---
	function renderExpensePage() {
		var main = document.getElementById('main-content');
		var html = '<div class="expense-summary-card">' +
				'<h4 style="margin-top:0; color:var(--deep-blue); display:flex; align-items:center; gap:8px;">ğŸ‘¥ æ—…ä¼´ç®¡ç†</h4>' +
				'<div id="companion-list">';
		
		for (var i = 0; i < state.companions.length; i++) {
			html += '<div class="companion-tag">' + state.companions[i] + 
					'<span class="remove-btn" onclick="removeCompanion(' + i + ')">âœ•</span></div>';
		}
		
		html += '</div>' +
				'<div style="display:flex; gap:10px; margin-top:15px; background:var(--bg-gray); padding:10px; border-radius:12px;">' +
				'<input type="text" id="new-companion" placeholder="è¼¸å…¥æ—…ä¼´å§“å" style="flex:1; border:none; background:transparent; outline:none; font-size:0.95rem;">' +
				'<button onclick="addCompanion()" style="background:var(--accent-blue); color:white; border:none; padding:8px 18px; border-radius:10px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3);">ï¼‹ æ–°å¢æ—…ä¼´</button>' +
				'</div></div>';

		// (è¨ˆç®—é‚è¼¯ä¿æŒä¸è®Šï¼Œç•¥é...)
		var balances = {}; 
		for (var k = 0; k < state.companions.length; k++) balances[state.companions[k]] = 0;
		
		function processExpense(ex) {
			if (!ex || !ex.amount) return;
			var amount = parseFloat(ex.amount) || 0;
			var payer = ex.paidBy;
			var sharers = (ex.sharedWith && ex.sharedWith.length > 0) ? ex.sharedWith : state.companions;
			if (balances[payer] !== undefined) balances[payer] += amount;
			var perPerson = amount / sharers.length;
			for (var x = 0; x < sharers.length; x++) {
				var sName = sharers[x];
				if (balances[sName] !== undefined) balances[sName] -= perPerson;
			}
		}

		state.itinerary.forEach(day => day.spots.forEach(spot => spot.expenses && spot.expenses.forEach(processExpense)));
		state.wishlist.forEach(item => item.expenses && item.expenses.forEach(processExpense));
		state.hotels.forEach(hotel => hotel.expenses && hotel.expenses.forEach(processExpense));
		state.flights.forEach(flight => flight.expenses && flight.expenses.forEach(processExpense));

		html += '<div class="expense-summary-card">' +
				'<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">' +
					'<h4 style="margin:0; color:var(--deep-blue);">ğŸ’° çµç®—çµ±è¨ˆ</h4>' +
					'<span style="font-size:0.8rem; color:#999;">å–®ä½ï¼šåŸºæº–å¹£å€¼</span>' +
				'</div>';

		state.companions.forEach(function(name) {
			var bal = Math.round(balances[name] * 100) / 100;
			var isPositive = bal >= 0;
			var color = isPositive ? '#2e7d32' : '#d32f2f';
			var bgColor = isPositive ? '#e8f5e9' : '#ffebee';
			var statusText = isPositive ? 'æ‡‰æ”¶å›' : 'æ‡‰çµ¦å‡º';
			var prefix = isPositive ? '+' : '';
			
			html += '<div class="balance-card-row">' +
						'<span class="status-label" style="background:' + bgColor + '; color:' + color + ';">' + statusText + '</span>' +
						'<span class="balance-name">' + name + '</span>' +
						'<div class="balance-amount">' +
							'<div style="color:' + color + '; font-weight:800; font-size:1.2rem;">' + prefix + bal.toLocaleString() + '</div>' +
						'</div>' +
					'</div>';
		});
		
		html += '<p style="font-size:0.75rem; color:#bbb; text-align:center; margin-top:15px;">â€» çµ±è¨ˆåŒ…å«è¡Œç¨‹ã€é£¯åº—ã€æ©Ÿç¥¨åŠé¡˜æœ›æ¸…å–®ä¹‹æ‰€æœ‰æ”¯å‡º</p></div>';
		main.innerHTML = html;
	}

	// --- æ—…ä¼´ç®¡ç†é…å¥—å‡½å¼ ---
	function addCompanion() {
		var input = document.getElementById('new-companion');
		var name = input.value.trim();
		if (!name) return alert('è«‹è¼¸å…¥å§“å');
		if (state.companions.indexOf(name) !== -1) return alert('å§“åé‡è¤‡äº†');
		
		state.companions.push(name);
		input.value = '';
		save();
		render(); // é‡æ–°æ¸²æŸ“æ•´å€‹é é¢
	}

	function removeCompanion(index) {
		if (state.companions.length <= 1) return alert('è‡³å°‘éœ€è¦ä¸€åæ—…ä¼´');
		if (confirm('ç¢ºå®šåˆªé™¤æ—…ä¼´ ' + state.companions[index] + 'ï¼Ÿ\né€™å¯èƒ½æœƒå½±éŸ¿çµç®—ç²¾ç¢ºåº¦ã€‚')) {
			state.companions.splice(index, 1);
			save();
			render();
		}
	}
	
	function editDayTitle(idx) {
		var oldTitle = state.itinerary[idx].title;
		var newTitle = prompt("è«‹è¼¸å…¥é€™ä¸€å¤©çš„åç¨±ï¼ˆä¾‹å¦‚ï¼šDay 1 æ±äº¬ï¼‰ï¼š", oldTitle);
		
		if (newTitle !== null && newTitle.trim() !== "") {
			state.itinerary[idx].title = newTitle.trim();
			save();
			render(); // é‡æ–°æ¸²æŸ“ Tabs èˆ‡å…§å®¹å€
		}
	}

	function renderAdminPage() {
		var main = document.getElementById('main-content');
		var html = `
			<div class="content">
				<div class="expense-summary-card" style="border-top: 5px solid var(--accent-blue);">
					<h3 style="margin-top:0;">âš™ï¸ ç®¡ç†è€…æ¨¡å¼</h3>
					<p style="font-size:0.85rem; color:#666;">æ‚¨å¯ä»¥é€éä¸‹æ–¹å€å¡Šå‚™ä»½æˆ–æ‰¹æ¬¡ä¿®æ”¹å…¨ç«™è³‡æ–™ã€‚</p>
					
					<div class="form-group">
						<label>ğŸ“Š å…¨åŸŸè³‡æ–™ JSON (State)</label>
						<textarea id="admin-json-area" 
							style="width:100%; height:350px; font-family:monospace; font-size:0.8rem; padding:12px; border-radius:12px; border:1px solid #e2e8f0; background:#f8fafc; line-height:1.4;"
						>${JSON.stringify(state, null, 2)}</textarea>
					</div>

					<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
						<button onclick="copyAdminJSON()" style="padding:12px; background:white; border:1.5px solid var(--accent-blue); color:var(--accent-blue); border-radius:12px; font-weight:bold; cursor:pointer;">ğŸ“‹ è¤‡è£½å‚™ä»½</button>
						<button onclick="applyAdminJSON()" style="padding:12px; background:var(--accent-blue); border:none; color:white; border-radius:12px; font-weight:bold; cursor:pointer; box-shadow: var(--shadow);">ğŸ’¾ å¯«å…¥è³‡æ–™</button>
					</div>
					
					<hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
					
					<h4 style="color:#d32f2f;">å±éšªå€åŸŸ</h4>
					<button onclick="clearAllData()" style="width:100%; padding:10px; background:#fff5f5; border:1px solid #feb2b2; color:#c53030; border-radius:10px; cursor:pointer; font-size:0.85rem;">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æœ¬åœ°è³‡æ–™</button>
				</div>
			</div>
		`;
		main.innerHTML = html;
	}

	// è¼”åŠ©å‡½å¼ï¼šå¥—ç”¨ JSON
	function applyAdminJSON() {
		const jsonStr = document.getElementById('admin-json-area').value;
		try {
			const parsed = JSON.parse(jsonStr);
			state = parsed;
			// åŒæ­¥åˆ° LocalStorage
			localStorage.setItem('travel_app_data', JSON.stringify(state));
			alert('âœ… è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼');
			render(); 
		} catch (e) {
			alert('âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¬¦è™Ÿæ˜¯å¦æˆå°ã€‚\n' + e.message);
		}
	}

	// è¼”åŠ©å‡½å¼ï¼šè¤‡è£½ JSON
	function copyAdminJSON() {
		const area = document.getElementById('admin-json-area');
		area.select();
		document.execCommand('copy');
		alert('ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
	}

	function clearAllData() {
		// è¨­å®šä½ æƒ³è¦çš„ PIN ç¢¼
		const SECRET_PIN = "8888"; 
		
		// ç¬¬ä¸€å±¤ç¢ºèªï¼šåŸºæœ¬é˜²èª¤è§¸
		if (!confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æ°¸ä¹…åˆªé™¤ç›®å‰ç€è¦½å™¨å­˜å„²çš„æ‰€æœ‰è¡Œç¨‹èˆ‡è¨˜å¸³ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
			return;
		}

		// ç¬¬äºŒå±¤ç¢ºèªï¼šè¼¸å…¥ PIN ç¢¼
		const userPin = prompt("ğŸ” è«‹è¼¸å…¥ç®¡ç†å“¡ PIN ç¢¼ä»¥åŸ·è¡Œæ¸…ç©ºå‹•ä½œï¼š");

		if (userPin === null) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

		if (userPin === SECRET_PIN) {
			localStorage.clear();
			alert('ğŸ—‘ï¸ æ‰€æœ‰æœ¬åœ°è³‡æ–™å·²æˆåŠŸæ¸…é™¤ã€‚ç¶²é å³å°‡é‡ç½®ã€‚');
			location.reload(); 
		} else {
			alert('âŒ PIN ç¢¼éŒ¯èª¤ï¼Œæ“ä½œå·²å–æ¶ˆã€‚');
		}
	}
	initApp();
    //render();
</script>
</body>
</html>